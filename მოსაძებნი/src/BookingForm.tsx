// @ts-nocheck
// BookingForm.tsx - Fixed syntax error and added proper imports
import React, { useState, useEffect, useMemo } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { collection, query, where, getDocs, addDoc, doc, getDoc, setDoc } from 'firebase/firestore';
import { db } from './firebaseConfig';
import { ArrowLeft, Calendar, Users, User, Clock } from 'lucide-react';
import { calculateSeasonalPrice, type PricingResult } from './utils/pricing';
import { checkUserExists, registerCustomerDuringBooking } from './services/userService';
import CustomCalendar from './components/Calendar';
import BookingAuth from './components/BookingAuth';
import { useAuth } from './contexts/useAuth';
import { useValidation } from './hooks/useValidation';
import WarningToast from './components/WarningToast';

interface BookingData {
  firstName: string;
  lastName: string;
  personalId: string;
  phone: string;
  password: string;
  adults: number;
  children: number;
  cottage: string;
  startDate: Date | null;
  endDate: Date | null;
  arrivalTime: string;
  departureTime: string;
  notes: string;
  useCustomPrice: boolean;
  customTotalPrice: number | null;
  ·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éò·Éö·Éò·Éê: boolean;
}

export default function BookingForm() {
  const { id } = useParams<{ id: string }>();
  const { user: authUser } = useAuth();
  const navigate = useNavigate();
  const [pricing, setPricing] = useState<PricingResult | null>(null);
  const [loading, setLoading] = useState(false);
  const [showAuthModal, setShowAuthModal] = useState(false);
  const [authenticatedUser, setAuthenticatedUser] = useState<any>(null);
  const [showPasswordField, setShowPasswordField] = useState(false);
  const [userCheckPerformed, setUserCheckPerformed] = useState(false);
  const [validationErrors, setValidationErrors] = useState<{[key: string]: string}>({});
  const { 
    isWarningToastVisible,
    hideValidationErrors: hideWarningToast,
    showWarningToast,
    validateBooking
  } = useValidation();
  const [userDetails, setUserDetails] = useState<any>(null);
  const [bookedDates, setBookedDates] = useState<Date[]>([]);
  const [isValidatingCode, setIsValidatingCode] = useState(false);
  const [cottageName, setCottageName] = useState<string>('·Éô·Éù·É¢·Éî·ÉØ·Éò');
  const [priceVerified, setPriceVerified] = useState(false);

  const [form, setForm] = useState<BookingData>({
    firstName: '',
    lastName: '',
    personalId: '',
    phone: '',
    password: '',
    adults: 1,
    children: 0,
    cottage: id || '',
    startDate: null,
    endDate: null,
    arrivalTime: '14:00',
    departureTime: '12:00',
    notes: '',
    useCustomPrice: false,
    customTotalPrice: null,
    ·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éò·Éö·Éò·Éê: false
  });

  // Load cottage name
  useEffect(() => {
    const fetchCottage = async () => {
      if (!id) {
        return;
      }
      try {
        const cottageDoc = await getDoc(doc(db, 'cottages', id));
        if (cottageDoc.exists()) {
          const cottageName = cottageDoc.data().name || '·Éô·Éù·É¢·Éî·ÉØ·Éò';
          setCottageName(cottageName);
        } else {
          setCottageName('·Éô·Éù·É¢·Éî·ÉØ·Éò');
        }
      } catch (error) {
        console.error('Error fetching cottage:', error);
        setCottageName('·Éô·Éù·É¢·Éî·ÉØ·Éò');
      }
    };

    // Only fetch if we don't already have a cottage name
    if (id && cottageName === '·Éô·Éù·É¢·Éî·ÉØ·Éò') {
      fetchCottage();
    }
  }, [id, cottageName]);

  // Load booked dates
  useEffect(() => {
    const fetchBookedDates = async () => {
      if (!id) return;
      try {
        const q = query(
          collection(db, 'bookings'), 
          where('cottage', '==', id),
          where('·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éò·Éö·Éò·Éê', '==', true)
        );
        const snap = await getDocs(q);
        const dates: Date[] = [];

        snap.forEach(doc => {
          const data = doc.data();
          if (data.startDate && data.endDate) {
            const startDate = data.startDate.toDate();
            const endDate = data.endDate.toDate();
            for (let d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) {
              dates.push(new Date(d));
            }
          }
        });

        setBookedDates(dates);
      } catch (error) {
        console.error('Error fetching booked dates:', error);
      }
    };
    fetchBookedDates();
  }, [id]);

  // Calculate pricing
  useEffect(() => {
    if (form.startDate && form.endDate && form.adults && form.endDate > form.startDate) {
      const pricingResult = calculateSeasonalPrice(
        form.startDate,
        form.endDate,
        form.adults,
        form.children,
        form.useCustomPrice,
        form.customTotalPrice
      );
      setPricing(pricingResult);
      setPriceVerified(true); // ·É§·Éê·É°·Éò ·Éí·Éê·Éõ·Éù·Éò·Éó·Éï·Éö·Éê, ·Éê·Éï·É¢·Éù·Éõ·Éê·É¢·É£·É†·Éê·Éì ·Éï·Éê·Éö·Éò·Éì·É£·É†·Éò·Éê
    } else {
      setPriceVerified(false);
    }
  }, [form.startDate, form.endDate, form.adults, form.children, form.useCustomPrice, form.customTotalPrice]);

  // Form validation
  const isFormValid = useMemo(() => {
    if (!priceVerified) {
      return false;
    }

    if (!form.startDate || !form.endDate) {
      return false;
    }

    if (!form.adults || form.adults < 1) {
      return false;
    }

    // ·Éó·É£ ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éî·Éë·É£·Éö·Éò·Éê, ·Éï·Éê·Éõ·Éù·É¨·Éõ·Éî·Éë·Éó authUser-·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·É°
    if (authUser) {
      const hasValidAuthData = (
        authUser.firstName && authUser.firstName.trim() !== '' &&
        authUser.lastName && authUser.lastName.trim() !== '' &&
        (authUser.personalId || authUser.phoneNumber || authUser.email)
      );

      return hasValidAuthData;
    }

    // ·Éó·É£ ·Éê·É†·Éê·Éê ·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éî·Éë·É£·Éö·Éò, ·Éï·Éê·Éõ·Éù·É¨·Éõ·Éî·Éë·Éó ·É§·Éù·É†·Éõ·Éò·É° ·Éû·Éò·É†·Éê·Éì ·Éò·Éú·É§·Éù·É°
    const personalInfoValid = (
      form.firstName.trim() !== '' &&
      form.lastName.trim() !== '' &&
      form.personalId.trim().length === 11 &&
      form.phone.trim().length >= 9
    );

    return personalInfoValid;
  }, [priceVerified, form.startDate, form.endDate, form.adults, form.firstName, form.lastName, form.personalId, form.phone, authUser]);

  const handleChange = async (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setForm(prev => ({
      ...prev,
      [name]: name === 'adults' || name === 'children'
        ? Number(value)
        : value
    }));

    // Real-time validation removed as per instruction

    // User existence check
    if (name === 'phone' || name === 'personalId') {
      setUserCheckPerformed(false);
      setShowPasswordField(false);
      setShowAuthModal(false);
      setAuthenticatedUser(null);

      if (value.length > 5) {
        setTimeout(async () => {
          await checkIfUserExists();
        }, 500);
      }
    }
  };

  const checkIfUserExists = async () => {
    // Skip check if user is already authenticated (any role)
    if (authUser) {
      console.log('‚úÖ User already authenticated, skipping check');
      return;
    }

    if (userCheckPerformed) return;
    if (!form.phone && !form.personalId) return;
    if (form.phone.length < 6 && form.personalId.length < 6) return;

    try {
      console.log('üîç Checking user existence in Firestore...');
      
      // Check both Firebase Auth and Firestore collections
      const phoneQueries = [
        query(collection(db, 'users'), where('phoneNumber', '==', form.phone.trim())),
        query(collection(db, 'clients'), where('phoneNumber', '==', form.phone.trim()))
      ];

      const personalIdQueries = [
        query(collection(db, 'users'), where('personalId', '==', form.personalId.trim())),
        query(collection(db, 'clients'), where('personalId', '==', form.personalId.trim()))
      ];

      const [usersPhoneSnapshot, clientsPhoneSnapshot, usersPersonalIdSnapshot, clientsPersonalIdSnapshot] = await Promise.all([
        getDocs(phoneQueries[0]),
        getDocs(phoneQueries[1]),
        getDocs(personalIdQueries[0]),
        getDocs(personalIdQueries[1])
      ]);

      const userExists = !usersPhoneSnapshot.empty || !clientsPhoneSnapshot.empty || 
                        !usersPersonalIdSnapshot.empty || !clientsPersonalIdSnapshot.empty;

      if (userExists) {
        console.log('‚úÖ User found in database');
        setShowAuthModal(true);
        setUserCheckPerformed(true);
        setShowPasswordField(true);
      } else {
        console.log('‚ÑπÔ∏è New user - registration will be offered during booking');
        setUserCheckPerformed(true);
        setShowPasswordField(false);
      }
    } catch (error) {
      console.error('‚ùå Error checking user existence:', error);
      setUserCheckPerformed(true);
    }
  };

  const handleAuthSuccess = (user: any) => {
    setAuthenticatedUser(user);
    setShowAuthModal(false);
    setForm(prev => ({
      ...prev,
      firstName: user.firstName,
      lastName: user.lastName,
      phone: user.phoneNumber || prev.phone,
      personalId: user.personalId || prev.personalId
    }));
  };

  const handleDateChange = (field: 'startDate' | 'endDate', date: Date | null) => {
    if (date) {
      setForm(prev => ({ ...prev, [field]: date }));
    }
  };

  const calculateNights = () => {
    if (!form.startDate || !form.endDate) return 0;
    const diffTime = Math.abs(form.endDate.getTime() - form.startDate.getTime());
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    console.log('üîÑ Starting booking submission...');

    try {
      // Validate form using new utility (only for non-authenticated users)
      if (!authUser) {
        const validationResult = validateBooking(form);

        if (!validationResult.isValid) {
          showWarningToast(validationResult.errors);
          return;
        }
      }

      // Personal data validation - different logic for authenticated vs non-authenticated users
      let firstName, lastName, personalId, phone;

      if (authUser) {
        // Use authUser data for authenticated users
        firstName = authUser.firstName;
        lastName = authUser.lastName;
        personalId = authUser.personalId || '';
        phone = authUser.phoneNumber || authUser.email || '';

        console.log('üìù Using authenticated user data:', { firstName, lastName, personalId, phone });

        if (!firstName?.trim() || !lastName?.trim()) {
          alert('·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éî·Éë·É£·Éö·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éê·É†·Éê·É°·É†·É£·Éö·Éò');
          return;
        }
      } else {
        // Use form data for non-authenticated users
        firstName = form.firstName;
        lastName = form.lastName;
        personalId = form.personalId;
        phone = form.phone;

        console.log('üìù Using form data:', { firstName, lastName, personalId, phone });

        if (!firstName?.trim() || !lastName?.trim() || !personalId?.trim() || !phone?.trim()) {
          alert('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éê·Éï·É°·Éù·Éó ·Éß·Éï·Éî·Éö·Éê ·Éê·É£·É™·Éò·Éö·Éî·Éë·Éî·Éö·Éò ·Éï·Éî·Éö·Éò');
          return;
        }
      }

      // Validate phone and personal ID format
      const phoneRegex = /^[0-9]{9}$/;
      const personalIdRegex = /^[0-9]{11}$/;

      if (!phoneRegex.test(form.phone.trim())) {
        alert('·É¢·Éî·Éö·Éî·É§·Éù·Éú·Éò·É° ·Éú·Éù·Éõ·Éî·É†·Éò ·É£·Éú·Éì·Éê ·É®·Éî·Éò·É™·Éê·Éï·Éì·Éî·É° ·Éñ·É£·É°·É¢·Éê·Éì 9 ·É™·Éò·É§·É†·É°');
        return;
      }

      if (!personalIdRegex.test(form.personalId.trim())) {
        alert('·Éû·Éò·É†·Éê·Éì·Éò ·Éú·Éù·Éõ·Éî·É†·Éò ·É£·Éú·Éì·Éê ·É®·Éî·Éò·É™·Éê·Éï·Éì·Éî·É° ·Éñ·É£·É°·É¢·Éê·Éì 11 ·É™·Éò·É§·É†·É°');
        return;
      }

      // Check if new user needs password
      if (!authenticatedUser && showPasswordField && (!form.password || form.password.length < 6)) {
        alert('·Éê·ÉÆ·Éê·Éö·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éò·É°·Éó·Éï·Éò·É° ·Éû·Éê·É†·Éù·Éö·Éò ·Éê·É£·É™·Éò·Éö·Éî·Éë·Éî·Éö·Éò·Éê (·Éõ·Éò·Éú·Éò·Éõ·É£·Éõ 6 ·É°·Éò·Éõ·Éë·Éù·Éö·Éù)');
        return;
      }

      // If user exists but not authenticated, show error
      if (userCheckPerformed && !authenticatedUser && !showPasswordField) {
        alert('·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·É£·Éô·Éï·Éî ·Éê·É†·É°·Éî·Éë·Éù·Éë·É°. ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éí·Éê·Éò·Éê·É†·Éî·Éó ·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éê·É™·Éò·Éê');
        return;
      }

      setLoading(true);

      let userId = authenticatedUser?.id;

      // Register new user if needed or find existing user
      if (!authenticatedUser) {
        console.log('üë§ Searching for user in Firestore or creating new...');

        try {
          // First, check if user exists by phone or personalId
          const phoneQuery = query(
            collection(db, 'clients'),
            where('phoneNumber', '==', form.phone.trim())
          );
          const phoneSnapshot = await getDocs(phoneQuery);

          const personalIdQuery = query(
            collection(db, 'clients'),
            where('personalId', '==', form.personalId.trim())
          );
          const personalIdSnapshot = await getDocs(personalIdQuery);

          if (!phoneSnapshot.empty) {
            const existingUser = phoneSnapshot.docs[0];
            userId = existingUser.id;
            console.log('‚úÖ Found existing user by phone:', userId);
          } else if (!personalIdSnapshot.empty) {
            const existingUser = personalIdSnapshot.docs[0];
            userId = existingUser.id;
            console.log('‚úÖ Found existing user by personalId:', userId);
          } else if (showPasswordField && form.password) {
            // Create new user
            console.log('üìù Creating new client in Firestore...');
            const clientRef = doc(collection(db, 'clients'));
            const newClientData = {
              firstName: form.firstName.trim(),
              lastName: form.lastName.trim(),
              phoneNumber: form.phone.trim(),
              personalId: form.personalId.trim(),
              createdAt: new Date(),
              updatedAt: new Date(),
              isActive: true
            };

            await setDoc(clientRef, newClientData);
            userId = clientRef.id;
            console.log('‚úÖ New client created with ID:', userId);
          } else {
            throw new Error('·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éò·É° ·Éò·Éì·Éî·Éú·É¢·Éò·É§·Éò·Éô·Éê·É™·Éò·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê');
          }
        } catch (registrationError: any) {
          console.error('‚ùå User management failed:', registrationError);
          throw new Error(`·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éò·É° ·Éõ·Éê·É†·Éó·Éï·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ${registrationError.message}`);
        }
      }

      if (!userId) {
        throw new Error('·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éò·É° ·Éò·Éì·Éî·Éú·É¢·Éò·É§·Éò·Éô·Éê·É™·Éò·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê - ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éí·Éê·Éò·Éê·É†·Éî·Éó ·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éê·É™·Éò·Éê');
      }

      console.log('üíæ Creating booking in Firestore...');

      // Calculate final pricing values
      const numberOfDays = calculateNights();
      const finalTotalPrice = form.useCustomPrice && form.customTotalPrice 
        ? form.customTotalPrice 
        : pricing?.totalPrice || 0;
      const finalDepositAmount = pricing?.depositAmount || Math.ceil(finalTotalPrice * 0.3);

      console.log(`üßÆ Booking price calculated: ${numberOfDays} days * rate = ${finalTotalPrice} ‚Çæ`);
      console.log(`üí∞ Deposit amount: ${finalDepositAmount} ‚Çæ`);

      // Prepare booking data for Firestore with proper date handling
      const bookingDataForFirestore = {
        // Core booking info
        firstName: firstName.trim(),
        lastName: lastName.trim(),
        phone: phone.trim(),
        personalId: personalId.trim(),
        cottage: form.cottage,

        // Dates as Firestore Timestamps
        startDate: form.startDate,
        endDate: form.endDate,

        // Guest info
        adults: form.adults,
        children: form.children,

        // Timing
        arrivalTime: form.arrivalTime,
        departureTime: form.departureTime,

        // Pricing - Always save totalPrice for admin view
        totalPrice: finalTotalPrice,
        depositAmount: finalDepositAmount,
        calculatedDays: numberOfDays,
        dailyRate: numberOfDays > 0 ? Math.round(finalTotalPrice / numberOfDays) : 0,
        useCustomPrice: form.useCustomPrice,
        customTotalPrice: form.useCustomPrice ? form.customTotalPrice : null,

        // Payment status
        ·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éò·Éö·Éò·Éê: form.·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éò·Éö·Éò·Éê,

        // Additional info
        notes: form.notes?.trim() || '',

        // User reference
        userId: userId,

        // Resource info for compatibility
        resourceType: 'cottage',
        resourceName: cottageName || '·Éô·Éù·É¢·Éî·ÉØ·Éò',
        resourceId: form.cottage,

        // Status tracking
        status: 'confirmed',
        isPaid: form.·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éò·Éö·Éò·Éê,

        // Timestamps
        createdAt: new Date(),
        updatedAt: new Date()
      };

      console.log('üìä Booking data prepared:', {
        customerName: `${bookingDataForFirestore.firstName} ${bookingDataForFirestore.lastName}`,
        cottage: bookingDataForFirestore.cottage,
        startDate: bookingDataForFirestore.startDate,
        endDate: bookingDataForFirestore.endDate,
        totalAmount: bookingDataForFirestore.totalPrice,
        userId: bookingDataForFirestore.userId
      });

      // Save to Firestore with error handling
      let docRef;
      try {
        docRef = await addDoc(collection(db, 'bookings'), bookingDataForFirestore);
      } catch (firestoreError: any) {
        console.error('‚ùå Firestore save error:', firestoreError);
        throw new Error(`·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éó·Éê ·Éë·Éê·Éñ·Éê·É®·Éò ·É®·Éî·Éú·Éê·ÉÆ·Éï·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê: ${firestoreError.message || '·É£·É™·Éú·Éù·Éë·Éò ·É®·Éî·É™·Éì·Éù·Éõ·Éê'}`);
      }

      if (!docRef?.id) {
        throw new Error('·ÉØ·Éê·Éï·É®·Éê·Éú·Éò ·É®·Éî·Éò·É•·Éõ·Éú·Éê, ·Éõ·Éê·Éí·É†·Éê·Éõ Document ID ·Éê·É† ·Éì·Éê·Éê·Éë·É†·É£·Éú·Éê Firestore-·Éõ');
      }

      console.log('‚úÖ Booking created successfully with ID:', docRef.id);

      alert('üéâ ·ÉØ·Éê·Éï·É®·Éê·Éú·Éò ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·É®·Éî·É•·Éõ·Éú·Éò·Éö·Éò·Éê!');
      navigate('/');

    } catch (error: any) {
      console.error('‚ùå Booking submission error:', error);

      // More detailed error message
      let errorMessage = '·É£·É™·Éú·Éù·Éë·Éò ·É®·Éî·É™·Éì·Éù·Éõ·Éê';
      if (error?.message) {
        errorMessage = error.message;
      } else if (typeof error === 'string') {
        errorMessage = error;
      }

      alert(`‚ùå ·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ${errorMessage}`);
    } finally {
      setLoading(false);
    }
  };

  // Load authenticated user details from Firestore - simplified
  useEffect(() => {
    // This test data loading is no longer needed and could cause performance issues
    // Removed to prevent unnecessary re-renders
  }, []);

  const isDateAvailable = (date: Date) => {
    return !bookedDates.some(bookedDate =>
      date.getDate() === bookedDate.getDate() &&
      date.getMonth() === bookedDate.getMonth() &&
      date.getFullYear() === bookedDate.getFullYear()
    );
  };

  const [customerInfo, setCustomerInfo] = useState({
    firstName: '',
    lastName: '',
    phoneNumber: '',
    email: ''
  });

  // Auto-fill form with authenticated user data for ALL user types
  useEffect(() => {
    if (authUser) {
      console.log('üîë Auto-filling form with authenticated user data:', authUser);
      setForm(prev => ({
        ...prev,
        firstName: authUser.firstName || '',
        lastName: authUser.lastName || '',
        phone: authUser.phoneNumber || authUser.email || '',
        personalId: authUser.personalId || ''
      }));
      setAuthenticatedUser(authUser);
      setUserCheckPerformed(true);
      setShowPasswordField(false); // User is already authenticated
    }
  }, [authUser]);

  // Debug form validation - simplified
  useEffect(() => {
    // Reduced logging to prevent infinite loops
    if (authUser) {
      console.log('üîß Form validation: authenticated user');
    }
  }, [authUser]);

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto px-4 flex items-center h-16">
          <button 
            onClick={() => navigate(-1)}
            className="flex items-center text-gray-600 hover:text-gray-800"
          >
            <ArrowLeft className="w-5 h-5 mr-2" />
            ·É£·Éô·Éê·Éú ·Éì·Éê·Éë·É†·É£·Éú·Éî·Éë·Éê
          </button>
        </div>
      </header>

      <div className="max-w-2xl mx-auto px-4 py-8">
        <div className="bg-white rounded-2xl shadow-lg p-8">
          <div className="text-center mb-8">
            <div className="text-4xl mb-4">üè†</div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·Éí·Éê·É§·Éù·É†·Éõ·Éî·Éë·Éê</h1>
            <p className="text-gray-600">{cottageName}</p>
          </div>

          <form onSubmit={handleSubmit} className="space-y-6">
            {/* Personal Information - Hidden for ALL authenticated users */}
            {authUser ? (
              /* ·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éî·Éë·É£·Éö·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éò·É°·Éó·Éï·Éò·É° ·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éê */
              <div className="bg-green-50 border border-green-200 rounded-lg p-6">
                <div className="flex items-center mb-2">
                  <User className="w-5 h-5 text-green-600 mr-2" />
                  <h3 className="text-lg font-semibold text-green-800">
                    ‚úÖ ·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éî·Éë·É£·Éö·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò
                  </h3>
                </div>
                <p className="text-green-800 font-medium">
                  {authUser.firstName} {authUser.lastName}
                </p>
                <p className="text-green-600 text-sm mt-1">
                  ·Éó·É•·Éï·Éî·Éú·Éò ·Éû·Éò·É†·Éê·Éì·Éò ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éê·Éï·É¢·Éù·Éõ·Éê·É¢·É£·É†·Éê·Éì ·Éí·Éê·Éõ·Éù·Éò·Éß·Éî·Éú·Éî·Éë·Éê ·ÉØ·Éê·Éï·É®·Éú·Éò·É°·Éó·Éï·Éò·É°
                </p>
              </div>
            ) : (
              <div className="bg-gray-50 p-6 rounded-xl">
                <h3 className="text-lg font-semibold mb-4 flex items-center">
                  <User className="w-5 h-5 mr-2" />
                  ·Éû·Éò·É†·Éê·Éì·Éò ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éê
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">·É°·Éê·ÉÆ·Éî·Éö·Éò *</label>
                    <input
                      name="firstName"
                      value={form.firstName}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éî·Éó ·É°·Éê·ÉÆ·Éî·Éö·Éò"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">·Éí·Éï·Éê·É†·Éò *</label>
                    <input
                      name="lastName"
                      value={form.lastName}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éî·Éó ·Éí·Éï·Éê·É†·Éò"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">·Éû·Éò·É†·Éê·Éì·Éò ·Éú·Éù·Éõ·Éî·É†·Éò *</label>
                    <input
                      name="personalId"
                      value={form.personalId}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="11 ·É™·Éò·É§·É†·Éò"
                      maxLength={11}
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">·É¢·Éî·Éö·Éî·É§·Éù·Éú·Éò *</label>
                    <input
                      name="phone"
                      value={form.phone}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="9 ·É™·Éò·É§·É†·Éò"
                      maxLength={9}
                      required
                    />
                  </div>
                  {showPasswordField && !authenticatedUser && (
                    <div className="col-span-2">
                      <label className="block text-sm font-medium text-gray-700 mb-2">·Éû·Éê·É†·Éù·Éö·Éò *</label>
                      <div className="relative">
                        <input
                          type="password"
                          name="password"
                          value={form.password}
                          onChange={handleChange}
                          className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="·Éõ·Éò·Éú·Éò·Éõ·É£·Éõ 6 ·É°·Éò·Éõ·Éë·Éù·Éö·Éù"
                          required={showPasswordField}
                        />
                      </div>
                    </div>
                  )}

                </div>
              </div>
            )}

            {/* Guest Count */}
            <div className="bg-gray-50 p-6 rounded-xl">
              <h3 className="text-lg font-semibold mb-4 flex items-center">
                <Users className="w-5 h-5 mr-2" />
                ·É°·É¢·É£·Éõ·É†·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê
              </h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">·Éñ·É†·Éì·Éê·É°·É†·É£·Éö·Éî·Éë·Éò</label>
                  <input
                    type="number"
                    name="adults"
                    value={form.adults}
                    min={1}
                    max={10}
                    onChange={handleChange}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">·Éë·Éê·Éï·É®·Éï·Éî·Éë·Éò</label>
                  <input
                    type="number"
                    name="children"
                    value={form.children}
                    min={0}
                    max={10}
                    onChange={handleChange}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>
            </div>

            {/* Dates */}
            <div className="bg-gray-50 p-6 rounded-xl">
              <h3 className="text-lg font-semibold mb-4 flex items-center">
                <Calendar className="w-5 h-5 mr-2" />
                ·Éó·Éê·É†·Éò·É¶·Éî·Éë·Éò
              </h3>
              <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <CustomCalendar 
                  bookedDates={bookedDates}
                  onDateSelect={(date) => {
                    if (!isDateAvailable(date)) return;

                    setForm(prev => {
                      if (!prev.startDate || (prev.startDate && prev.endDate)) {
                        return { ...prev, startDate: date, endDate: null };
                      } else if (prev.startDate && !prev.endDate) {
                        if (date > prev.startDate) {
                          return { ...prev, endDate: date };
                        } else {
                          return { ...prev, startDate: date, endDate: null };
                        }
                      }
                      return prev;
                    });
                  }}
                  selectedDate={form.startDate}
                  endDate={form.endDate}
                  minDate={new Date()}
                  className="mx-auto"
                />

                <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                  <div className="text-sm space-y-1">
                    <div className="flex justify-between">
                      <span className="font-medium text-blue-800">·Éõ·Éù·É°·Éï·Éö·Éê:</span>
                      <span className="text-blue-700">
                        {form.startDate ? form.startDate.toLocaleDateString('ka-GE') : '·Éê·É† ·Éê·É†·Éò·É° ·Éê·É†·É©·Éî·É£·Éö·Éò'}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="font-medium text-blue-800">·É¨·Éê·É°·Éï·Éö·Éê:</span>
                      <span className="text-blue-700">
                        {form.endDate ? form.endDate.toLocaleDateString('ka-GE') : '·Éê·É† ·Éê·É†·Éò·É° ·Éê·É†·É©·Éî·É£·Éö·Éò'}
                      </span>
                    </div>
                    {form.startDate && form.endDate && (
                      <div className="flex justify-between pt-2 border-t border-blue-200">
                        <span className="font-medium text-blue-800">·É¶·Éê·Éõ·Éî·Éî·Éë·Éò:</span>
                        <span className="text-blue-700 font-semibold">{calculateNights()}</span>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {pricing && (
            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6">
              <h3 className="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                üí∞ ·É§·Éê·É°·Éò·É° ·Éì·Éî·É¢·Éê·Éö·Éî·Éë·Éò
              </h3>
              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <span className="text-gray-600">·Éë·Éê·Éñ·Éò·É°·É£·É†·Éò ·É¢·Éê·É†·Éò·É§·Éò ({pricing.season}):</span>
                  <span className="font-semibold">{pricing.baseRate}‚Çæ</span>
                </div>

                {pricing.additionalGuestFee > 0 && (
                  <div className="flex justify-between items-center">
                    <span className="text-gray-600">·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éò·Éó·Éò ·Éñ·É†·Éì·Éê·É°·É†·É£·Éö·Éò ({Math.round(pricing.additionalGuestFee / 20)}):</span>
                    <span className="font-semibold text-orange-600">+{pricing.additionalGuestFee}‚Çæ</span>
                  </div>
                )}

                <div className="flex justify-between items-center">
                  <span className="text-gray-600">·Éô·Éù·Éõ·É£·Éú·Éê·Éö·É£·É†·Éò ·Éõ·Éù·Éõ·É°·Éê·ÉÆ·É£·É†·Éî·Éë·Éê:</span>
                  <span className="font-semibold text-green-600">+{pricing.utilityCost}‚Çæ</span>
                </div>

                {pricing.dynamicPriceMultiplier !== 1.0 && (
                  <div className="flex justify-between items-center">
                    <span className="text-gray-600">·Éì·Éò·Éú·Éê·Éõ·Éò·É£·É†·Éò ·É§·Éê·É°·Éò ({pricing.daysUntilCheckIn} ·Éì·É¶·Éî):</span>
                    <span className="font-semibold text-red-600">√ó{pricing.dynamicPriceMultiplier.toFixed(2)}</span>
                  </div>
                )}

                <div className="flex justify-between items-center">
                  <span className="text-gray-600">·É¶·Éê·Éõ·Éî·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê:</span>
                  <span className="font-semibold">{pricing.nights}</span>
                </div>

                {pricing.isLongStay && (
                  <div className="text-green-600 text-sm font-medium bg-green-50 px-3 py-1 rounded-full">
                    ‚úì ·Éí·É†·É´·Éî·Éö·Éï·Éê·Éì·Éò·Éê·Éú·Éò ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·Éê (21+ ·É¶·Éê·Éõ·Éî) - ·É§·Éê·É°·Éì·Éê·Éô·Éö·Éî·Éë·Éê
                  </div>
                )}

                <hr className="border-blue-200" />

                <div className="flex justify-between items-center text-lg">
                  <span className="font-semibold text-gray-700">·É¶·Éê·Éõ·Éî·É®·Éò:</span>
                  <span className="font-bold text-blue-600">{pricing.pricePerNight}‚Çæ</span>
                </div>

                <div className="flex justify-between items-center text-xl bg-blue-100 p-3 rounded-lg">
                  <span className="font-bold text-blue-800">·ÉØ·Éê·Éõ·É£·É†·Éò ·É§·Éê·É°·Éò:</span>
                  <span className="font-bold text-blue-800">{pricing.totalPrice}‚Çæ</span>
                </div>

                <div className="flex justify-between items-center text-lg bg-orange-100 p-3 rounded-lg">
                  <span className="font-bold text-orange-800">·É¨·Éò·Éú·Éê·Éì·Éî·Éë·Éî·É¢·Éò ({Math.round((pricing.depositAmount / pricing.totalPrice) * 100)}%):</span>
                  <span className="font-bold text-orange-800">{pricing.depositAmount}‚Çæ</span>
                </div>
              </div>
            </div>
          )}
            </div>

            {/* Time */}
            <div className="bg-gray-50 p-6 rounded-xl">
              <h3 className="text-lg font-semibold mb-4 flex items-center">
                <Clock className="w-5 h-5 mr-2" />
                ·Éì·É†·Éù
              </h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">·Éõ·Éù·É°·Éï·Éö·Éò·É° ·Éì·É†·Éù</label>
                  <input
                    type="time"
                    name="arrivalTime"
                    value={form.arrivalTime}
                    onChange={handleChange}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">·Éí·Éê·É°·Éï·Éö·Éò·É° ·Éì·É†·Éù</label>
                  <input
                    type="time"
                    name="departureTime"
                    value={form.departureTime}
                    onChange={handleChange}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>
            </div>

            {/* ·Éò·Éú·Éì·Éò·Éï·Éò·Éì·É£·Éê·Éö·É£·É†·Éò ·É§·Éê·É°·Éò */}
            <div className="bg-orange-50 p-6 rounded-xl border border-orange-200">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h3 className="text-lg font-semibold text-orange-800 flex items-center">
                    üí∞ ·Éò·Éú·Éì·Éò·Éï·Éò·Éì·É£·Éê·Éö·É£·É†·Éò ·É§·Éê·É°·Éò
                  </h3>
                  <p className="text-sm text-orange-700 mt-1">·É°·Éû·Éî·É™·Éò·Éê·Éö·É£·É†·Éò ·É§·Éê·É°·Éò·É° ·Éõ·Éò·É°·Éê·Éú·Éò·É≠·Éî·Éë·Éî·Éö·Éò</p>
                </div>
                <label className="relative inline-flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    checked={form.useCustomPrice}
                    onChange={(e) => setForm(prev => ({ 
                      ...prev,                       useCustomPrice: e.target.checked,
                      customTotalPrice: e.target.checked ? prev.customTotalPrice : null
                    }))}
                    className="sr-only peer"
                  />
                  <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-600"></div>
                  <span className="ml-3 text-sm font-medium text-orange-800">·Éí·Éê·Éõ·Éù·É†·Éó·É£·Éö·Éò</span>
                </label>
              </div>

              {form.useCustomPrice && (
                <div>
                  <label className="block text-sm font-medium text-orange-700 mb-2">·ÉØ·Éê·Éõ·É£·É†·Éò ·É¶·Éò·É†·Éî·Éë·É£·Éö·Éî·Éë·Éê (‚Çæ)</label>
                  <input
                    type="number"
                    value={form.customTotalPrice || ''}
                    onChange={(e) => setForm(prev => ({ 
                      ...prev, 
                      customTotalPrice: e.target.value ? Number(e.target.value) : null 
                    }))}
                    className="w-full px-4 py-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white"
                    placeholder="·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éî·Éó ·É°·Éû·Éî·É™·Éò·Éê·Éö·É£·É†·Éò ·É§·Éê·É°·Éò"
                    min="1"
                  />
                  <p className="mt-2 text-xs text-orange-600">
                    ‚ÑπÔ∏è ·Éò·Éú·Éì·Éò·Éï·Éò·Éì·É£·Éê·Éö·É£·É†·Éò ·É§·Éê·É°·Éò ·É©·Éê·Éê·Éú·Éê·É™·Éï·Éö·Éî·Éë·É° ·Éê·Éï·É¢·Éù·Éõ·Éê·É¢·É£·É† ·Éô·Éê·Éö·Éô·É£·Éö·Éê·É™·Éò·Éê·É°
                  </p>
                </div>
              )}
            </div>

            {/* Notes */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">·É®·Éî·Éú·Éò·É®·Éï·Éú·Éî·Éë·Éò</label>
              <textarea
                name="notes"
                value={form.notes}
                onChange={handleChange}
                rows={4}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éò·Éó·Éò ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éê..."
                maxLength={500}
              />
            </div>

            {/* Payment Status */}
            <div className="bg-gray-50 p-6 rounded-xl">
              <label className="flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  name="·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éò·Éö·Éò·Éê"
                  checked={form.·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éò·Éö·Éò·Éê}
                  onChange={(e) => setForm(prev => ({ ...prev, ·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éò·Éö·Éò·Éê: e.target.checked }))}
                  className="mr-3 h-4 w-4 text-blue-600 rounded"
                />
                <span className="text-sm font-medium text-gray-700">
                  ·Éí·Éê·Éì·Éê·ÉÆ·Éì·Éò·Éö·Éò·Éê (·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·Éê·Éì·Éõ·Éò·Éú·Éò·É°·É¢·É†·Éê·É™·Éò·Éò·É°·Éó·Éï·Éò·É°)
                </span>
              </label>
            </div>

            {/* Buttons */}
            <div className="flex gap-4 pt-6">
              <button
                type="button"
                onClick={() => navigate(-1)}
                className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-lg font-medium transition-colors"
              >
                ·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê
              </button>
              <button
                type="submit"
                disabled={loading || !isFormValid}
                className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center"
              >
                {loading ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                    ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê...
                  </>
                ) : (
                  '·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê'
                )}
              </button>
            </div>
          </form>
        </div>
      </div>

      {/* Authentication Modal */}
      {showAuthModal && (
        <BookingAuth
          onAuthSuccess={handleAuthSuccess}
          onBack={() => {
            setShowAuthModal(false);
            setUserCheckPerformed(false);
          }}
          preFilledPhone={form.phone}
          preFilledPersonalId={form.personalId}
        />
      )}

      {/* Warning Toast */}
      <WarningToast
        isVisible={isWarningToastVisible}
        onClose={hideWarningToast}
        messages={validationErrors}
        title="·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·É§·Éù·É†·Éõ·Éê ·Éê·É†·Éê·É°·É†·É£·Éö·Éò"
        type="warning"
        position="top"
        autoClose={true}
      />
    </div>
  );
}
// Clean syntax validation
// END