/**
 * ­ЪЄг­ЪЄф Georgian Grammar Parser and Morphological Analyzer
 *
 * This module augments Gurulo's Georgian support with:
 * - Morphological analysis (cases, numbers, verb conjugations)
 * - Syntax validation with lightweight parse tree generation
 * - Rule-based error detection combined with heuristic ML-style scoring
 * - Reference dataset for in-context grammar calibration
 */

export type GeorgianCase =
  | 'nominative'
  | 'ergative'
  | 'dative'
  | 'genitive'
  | 'instrumental'
  | 'adverbial'
  | 'vocative'
  | 'accusative';

export type GeorgianPartOfSpeech =
  | 'noun'
  | 'verb'
  | 'adjective'
  | 'adverb'
  | 'pronoun'
  | 'particle'
  | 'postposition'
  | 'unknown';

export interface GeorgianMorphologicalToken {
  original: string;
  normalized: string;
  lemma: string;
  partOfSpeech: GeorgianPartOfSpeech;
  case?: GeorgianCase;
  number?: 'singular' | 'plural';
  person?: 1 | 2 | 3;
  tense?: 'present' | 'past' | 'future' | 'perfect';
  mood?: 'indicative' | 'imperative' | 'conditional';
  rootConfidence: number;
  mlScore: number;
  notes?: string[];
}

export interface GeorgianGrammarError {
  type: 'case' | 'agreement' | 'syntax' | 'spelling' | 'unknown';
  token: string;
  message: string;
  severity: 'low' | 'medium' | 'high';
  rule: string;
  suggestion?: string;
  confidence: number;
}

export interface GeorgianGrammarSuggestion {
  message: string;
  replacement?: string;
  rule: string;
  confidence: number;
}

export interface GeorgianSyntaxNode {
  label: string;
  tokens: string[];
  children?: GeorgianSyntaxNode[];
}

export interface GeorgianParseResult {
  tokens: GeorgianMorphologicalToken[];
  syntaxTree: GeorgianSyntaxNode[];
  errors: GeorgianGrammarError[];
  suggestions: GeorgianGrammarSuggestion[];
  correctedText: string;
  datasetExamples: typeof GEORGIAN_GRAMMAR_DATASET;
}

interface GrammarParserOptions {
  strict?: boolean;
  preserveEnglishTerms?: boolean;
}

interface GrammarDatasetEntry {
  input: string;
  corrected: string;
  explanation: string;
  focus: 'case' | 'agreement' | 'syntax' | 'spelling';
}

const GEORGIAN_CASE_RULES: Array<{
  case: GeorgianCase;
  suffixes: string[];
  description: string;
}> = [
  {
    case: 'nominative',
    suffixes: ['', 'рЃћрЃЉрЃў', 'рЃћрЃЉрЃў'],
    description: 'рЃАрЃљрЃгрЃДрЃўрЃАрЃў рЃЉрЃарЃБрЃюрЃЋрЃљ РђЊ рЃЏрЃљрЃарЃ»рЃЋрЃћрЃюрЃљ рЃАрЃБрЃцрЃўрЃЦрЃАрЃў рЃљрЃа рЃљрЃЦрЃЋрЃА рЃљрЃю рЃљрЃЦрЃЋрЃА -рЃћрЃЉрЃў рЃЏрЃарЃљрЃЋрЃџрЃЮрЃЉрЃўрЃЌрЃўрЃАрЃЌрЃЋрЃўрЃА.'
  },
  {
    case: 'ergative',
    suffixes: ['рЃЏрЃљ', 'рЃћрЃЉрЃЏрЃљ', 'рЃћрЃЉрЃЏрЃљ'],
    description: 'рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃўрЃА рЃЉрЃарЃБрЃюрЃЋрЃљ РђЊ рЃ«рЃерЃўрЃарЃЊ рЃљрЃЎрЃљрЃЋрЃерЃўрЃарЃћрЃЉрЃА рЃЏрЃЮрЃЋрЃџрЃћрЃюрЃўрЃА рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃА (-рЃЏрЃљ).' 
  },
  {
    case: 'dative',
    suffixes: ['рЃА', 'рЃћрЃЉрЃА', 'рЃАрЃЌрЃЋрЃўрЃА', 'рЃћрЃЉрЃАрЃЌрЃЋрЃўрЃА'],
    description: 'рЃЏрЃўрЃфрЃћрЃЏрЃўрЃЌрЃў рЃЉрЃарЃБрЃюрЃЋрЃљ РђЊ -рЃА/-рЃАрЃЌрЃЋрЃўрЃА, рЃЏрЃўрЃќрЃюрЃўрЃА рЃљрЃю рЃЏрЃўрЃЏрЃдрЃћрЃЉрЃўрЃА рЃљрЃдрЃАрЃљрЃюрЃўрЃерЃюрЃљрЃЋрЃљрЃЊ.'
  },
  {
    case: 'genitive',
    suffixes: ['рЃўрЃА', 'рЃћрЃЉрЃўрЃА', 'рЃЌрЃљ'],
    description: 'рЃюрЃљрЃЌрЃћрЃАрЃљрЃЮрЃЉрЃўрЃЌрЃў рЃЉрЃарЃБрЃюрЃЋрЃљ РђЊ рЃЎрЃБрЃЌрЃЋрЃюрЃўрЃџрЃћрЃЉрЃўрЃА рЃљрЃю рЃгрЃљрЃарЃЏрЃЮрЃЏрЃљрЃЋрЃџрЃЮрЃЉрЃўрЃА рЃљрЃдрЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃў.'
  },
  {
    case: 'instrumental',
    suffixes: ['рЃўрЃЌ', 'рЃћрЃЉрЃўрЃЌ'],
    description: 'рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃћрЃЉрЃўрЃЌрЃў рЃЉрЃарЃБрЃюрЃЋрЃљ РђЊ рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃћрЃЉрЃўрЃА рЃўрЃљрЃарЃљрЃдрЃў рЃљрЃю рЃАрЃљрЃерЃБрЃљрЃџрЃћрЃЉрЃљ.'
  },
  {
    case: 'adverbial',
    suffixes: ['рЃљрЃЊ'],
    description: 'рЃЋрЃўрЃЌрЃљрЃарЃћрЃЉрЃўрЃЌрЃў рЃЉрЃарЃБрЃюрЃЋрЃљ РђЊ рЃЏрЃЊрЃњрЃЮрЃЏрЃљрЃарЃћрЃЮрЃЉрЃўрЃА рЃљрЃю рЃЌрЃЋрЃўрЃАрЃћрЃЉрЃўрЃА рЃљрЃдрЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃў.'
  },
  {
    case: 'vocative',
    suffixes: ['рЃЮ'],
    description: 'рЃЏрЃЮрЃфрЃЮрЃЉрЃўрЃЌрЃў рЃЉрЃарЃБрЃюрЃЋрЃљ РђЊ рЃЏрЃўрЃЏрЃљрЃарЃЌрЃЋрЃўрЃАрЃљрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃБрЃџрЃў рЃцрЃЮрЃарЃЏрЃљ.'
  },
  {
    case: 'accusative',
    suffixes: ['рЃА', 'рЃА', 'рЃћрЃЉрЃА'],
    description: 'рЃАрЃљрЃњрЃюрЃЮрЃЉрЃўрЃЌрЃў рЃЉрЃарЃБрЃюрЃЋрЃљ РђЊ рЃњрЃљрЃЊрЃљрЃЊрЃўрЃА рЃЮрЃЉрЃўрЃћрЃЦрЃбрЃќрЃћ (-рЃА/-рЃћрЃЉрЃА).' 
  }
];

const COMMON_PRONOUNS: Record<string, { person: 1 | 2 | 3; number: 'singular' | 'plural' }> = {
  'рЃЏрЃћ': { person: 1, number: 'singular' },
  'рЃЕрЃЋрЃћрЃю': { person: 1, number: 'plural' },
  'рЃерЃћрЃю': { person: 2, number: 'singular' },
  'рЃЌрЃЦрЃЋрЃћрЃю': { person: 2, number: 'plural' },
  'рЃўрЃА': { person: 3, number: 'singular' },
  'рЃўрЃАрЃўрЃюрЃў': { person: 3, number: 'plural' }
};

const VERB_PATTERNS: Array<{
  lemma: string;
  forms: string[];
  tense: GeorgianMorphologicalToken['tense'];
  personGuesses: Array<{ startsWith: string; person: 1 | 2 | 3 }>;
}> = [
  {
    lemma: 'рЃ«рЃћрЃЊрЃЋрЃљ',
    forms: ['рЃЋрЃ«рЃћрЃЊрЃљрЃЋ', 'рЃ«рЃћрЃЊрЃљрЃЋ', 'рЃ«рЃћрЃЊрЃљрЃЋрЃА', 'рЃЋрЃюрЃљрЃ«рЃћ', 'рЃюрЃљрЃ«рЃљ', 'рЃЋрЃ«рЃћрЃЊрЃљрЃЋрЃЌ', 'рЃ«рЃћрЃЊрЃљрЃЋрЃћрЃю'],
    tense: 'present',
    personGuesses: [
      { startsWith: 'рЃЋ', person: 1 },
      { startsWith: 'рЃњ', person: 2 },
      { startsWith: '', person: 3 }
    ]
  },
  {
    lemma: 'рЃгрЃћрЃарЃљ',
    forms: ['рЃЋрЃгрЃћрЃа', 'рЃгрЃћрЃа', 'рЃгрЃћрЃарЃА', 'рЃЋрЃгрЃћрЃарЃЊрЃў', 'рЃгрЃћрЃарЃЊрЃљ', 'рЃЊрЃљрЃЋрЃгрЃћрЃа', 'рЃЊрЃљрЃгрЃћрЃарЃљ'],
    tense: 'present',
    personGuesses: [
      { startsWith: 'рЃЋ', person: 1 },
      { startsWith: 'рЃЊ', person: 1 },
      { startsWith: 'рЃгрЃћрЃа', person: 2 }
    ]
  },
  {
    lemma: 'рЃЋрЃџрЃљ',
    forms: ['рЃЏрЃЮрЃЋрЃћрЃЊрЃў', 'рЃЏрЃўрЃЋрЃЊрЃўрЃЋрЃљрЃа', 'рЃЏрЃўрЃЋрЃћрЃЊрЃў', 'рЃЏрЃўрЃЋрЃўрЃЊрЃљ', 'рЃЏрЃўрЃЋрЃЊрЃўрЃЋрЃљрЃарЃЌ'],
    tense: 'past',
    personGuesses: [
      { startsWith: 'рЃЏрЃЮ', person: 1 },
      { startsWith: 'рЃЏрЃў', person: 1 },
      { startsWith: 'рЃљ', person: 3 }
    ]
  }
];

const ADJECTIVE_AGREEMENT_RULES: Array<{
  singular: string[];
  plural: string[];
  description: string;
}> = [
  {
    singular: ['рЃў', 'рЃћ'],
    plural: ['рЃћрЃЉрЃў', 'рЃБрЃарЃў'],
    description: 'рЃерЃћрЃАрЃљрЃЉрЃљрЃЏрЃўрЃАрЃў рЃќрЃћрЃЊрЃАрЃљрЃарЃЌрЃљрЃЋрЃў РђЊ рЃЏрЃарЃљрЃЋрЃџрЃЮрЃЉрЃўрЃЌрЃерЃў рЃ«рЃерЃўрЃарЃљрЃЊ -рЃћрЃЉрЃў/-рЃБрЃарЃў рЃћрЃЏрЃљрЃбрЃћрЃЉрЃљ.'
  },
  {
    singular: ['рЃБрЃџрЃў'],
    plural: ['рЃБрЃџрЃћрЃЉрЃў'],
    description: 'рЃќрЃћрЃЊрЃАрЃљрЃарЃЌрЃљрЃЋрЃў, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃљрЃарЃАрЃћрЃЉрЃўрЃЌрЃА рЃЏрЃўрЃ░рЃДрЃЋрЃћрЃЉрЃљ (рЃЏрЃљрЃњ. рЃЎрЃБрЃџрЃбрЃБрЃарЃБрЃџрЃў Рєњ рЃЎрЃБрЃџрЃбрЃБрЃарЃБрЃџрЃћрЃЉрЃў).'
  }
];

export const GEORGIAN_GRAMMAR_DATASET: GrammarDatasetEntry[] = [
  {
    input: 'рЃЏрЃћ рЃЋрЃ«рЃћрЃЊрЃљрЃЋ рЃ«рЃћ-рЃА',
    corrected: 'рЃЏрЃћ рЃЋрЃ«рЃћрЃЊрЃљрЃЋ рЃ«рЃћрЃА',
    explanation: 'рЃАрЃљрЃњрЃюрЃЮрЃЉрЃўрЃЌрЃў рЃЉрЃарЃБрЃюрЃЋрЃўрЃА рЃАрЃБрЃцрЃўрЃЦрЃАрЃў -рЃА рЃ░рЃўрЃцрЃћрЃюрЃўрЃА рЃњрЃљрЃарЃћрЃерЃћ рЃўрЃгрЃћрЃарЃћрЃЉрЃљ.',
    focus: 'case'
  },
  {
    input: 'рЃўрЃА рЃгрЃљрЃЋрЃўрЃЊрЃљ рЃАрЃЎрЃЮрЃџрЃљрЃерЃў',
    corrected: 'рЃўрЃА рЃгрЃљрЃЋрЃўрЃЊрЃљ рЃАрЃЎрЃЮрЃџрЃљрЃерЃў',
    explanation: 'рЃАрЃгрЃЮрЃарЃў рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљ РђЊ рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃў + рЃќрЃЏрЃюрЃљ + рЃЊрЃљрЃюрЃўрЃерЃюрЃБрЃџрЃћрЃЉрЃљ.',
    focus: 'syntax'
  },
  {
    input: 'рЃЕрЃЋрЃћрЃю рЃЋрЃюрЃљрЃ«рЃћ рЃцрЃўрЃџрЃЏрЃў',
    corrected: 'рЃЕрЃЋрЃћрЃю рЃЋрЃюрЃљрЃ«рЃћрЃЌ рЃцрЃўрЃџрЃЏрЃў',
    explanation: 'рЃќрЃЏрЃюрЃўрЃА рЃърЃўрЃарЃў рЃБрЃюрЃЊрЃљ рЃЊрЃљрЃћрЃЏрЃЌрЃ«рЃЋрЃћрЃА рЃЏрЃарЃљрЃЋрЃџрЃЮрЃЉрЃўрЃЌ рЃАрЃБрЃЉрЃўрЃћрЃЦрЃбрЃА.',
    focus: 'agreement'
  },
  {
    input: 'рЃерЃћрЃю рЃЊрЃљрЃгрЃћрЃарЃћ рЃЎрЃЮрЃЊрЃў',
    corrected: 'рЃерЃћрЃю рЃЊрЃљрЃгрЃћрЃарЃћ рЃЎрЃЮрЃЊрЃў',
    explanation: 'рЃЏрЃћрЃЮрЃарЃћ рЃърЃўрЃарЃўрЃА рЃћрЃарЃЌ. рЃцрЃЮрЃарЃЏрЃљ рЃАрЃгрЃЮрЃарЃљрЃЊрЃљрЃљ рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃБрЃџрЃў.',
    focus: 'syntax'
  },
  {
    input: 'рЃўрЃАрЃўрЃюрЃў рЃЎрЃўрЃЌрЃ«рЃБрЃџрЃЮрЃЉрЃА рЃгрЃўрЃњрЃюрЃА',
    corrected: 'рЃўрЃАрЃўрЃюрЃў рЃЎрЃўрЃЌрЃ«рЃБрЃџрЃЮрЃЉрЃћрЃю рЃгрЃўрЃњрЃюрЃА',
    explanation: 'рЃЏрЃарЃљрЃЋрЃџрЃЮрЃЉрЃўрЃЌрЃў рЃАрЃБрЃЉрЃўрЃћрЃЦрЃбрЃў рЃЏрЃЮрЃўрЃЌрЃ«рЃЮрЃЋрЃА рЃќрЃЏрЃюрЃўрЃА рЃЏрЃарЃљрЃЋрЃџрЃЮрЃЉрЃўрЃЌ рЃцрЃЮрЃарЃЏрЃљрЃА.',
    focus: 'agreement'
  },
  {
    input: 'рЃЏрЃћ рЃЏрЃўрЃЋрЃЊрЃўрЃЋрЃљрЃа рЃЉрЃљрЃЌрЃБрЃЏрЃерЃў',
    corrected: 'рЃЏрЃћ рЃЏрЃўрЃЋрЃЊрЃўрЃЋрЃљрЃа рЃЉрЃљрЃЌрЃБрЃЏрЃерЃў',
    explanation: 'рЃЊрЃљрЃфрЃБрЃџрЃў рЃАрЃўрЃбрЃДрЃЋрЃљрЃЌрЃгрЃДрЃЮрЃЉрЃљ: рЃАрЃБрЃЉрЃўрЃћрЃЦрЃбрЃў + рЃќрЃЏрЃюрЃљ + рЃЊрЃљрЃюрЃўрЃерЃюрЃБрЃџрЃћрЃЉрЃљ.',
    focus: 'syntax'
  },
  {
    input: 'рЃЊрЃћрЃЊрЃљрЃЏ рЃњрЃљрЃљрЃЎрЃћрЃЌрЃћрЃА рЃЋрЃљрЃ«рЃерЃљрЃЏрЃў',
    corrected: 'рЃЊрЃћрЃЊрЃљрЃЏ рЃњрЃљрЃљрЃЎрЃћрЃЌрЃљ рЃЋрЃљрЃ«рЃерЃљрЃЏрЃў',
    explanation: 'рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃўрЃА рЃЉрЃарЃБрЃюрЃЋрЃљ рЃЏрЃЮрЃўрЃЌрЃ«рЃЮрЃЋрЃА рЃЏрЃћрЃАрЃљрЃЏрЃћ рЃърЃўрЃарЃўрЃА рЃћрЃарЃЌ. рЃќрЃЏрЃюрЃљрЃА.',
    focus: 'agreement'
  },
  {
    input: 'рЃЎрЃљрЃарЃњрЃў рЃЉрЃљрЃЋрЃерЃЋрЃћрЃЉрЃў',
    corrected: 'рЃЎрЃљрЃарЃњрЃў рЃЉрЃљрЃЋрЃерЃЋрЃћрЃЉрЃў',
    explanation: 'рЃќрЃћрЃЊрЃАрЃљрЃарЃЌрЃљрЃЋрЃў рЃћрЃЌрЃљрЃюрЃ«рЃЏрЃћрЃЉрЃљ рЃљрЃарЃАрЃћрЃЉрЃўрЃЌрЃА рЃЏрЃарЃљрЃЋрЃџрЃЮрЃЉрЃўрЃЌрЃерЃў.',
    focus: 'agreement'
  },
  {
    input: 'рЃАрЃбрЃБрЃЊрЃћрЃюрЃбрЃЏрЃљ рЃЊрЃљрЃгрЃћрЃарЃљ рЃгрЃћрЃарЃўрЃџрЃў рЃЎрЃљрЃџрЃЏрЃўрЃЌ',
    corrected: 'рЃАрЃбрЃБрЃЊрЃћрЃюрЃбрЃЏрЃљ рЃЊрЃљрЃгрЃћрЃарЃљ рЃгрЃћрЃарЃўрЃџрЃў рЃЎрЃљрЃџрЃЏрЃўрЃЌ',
    explanation: 'рЃўрЃюрЃАрЃбрЃарЃБрЃЏрЃћрЃюрЃбрЃљрЃџрЃБрЃарЃў рЃЉрЃарЃБрЃюрЃЋрЃљ (-рЃўрЃЌ) рЃАрЃгрЃЮрЃарЃљрЃЊрЃљрЃљ рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃБрЃџрЃў.',
    focus: 'case'
  },
  {
    input: 'рЃАрЃљрЃ«рЃџрЃЌрЃљрЃю рЃЏрЃўрЃЋрЃћрЃЊрЃў рЃАрЃгрЃарЃљрЃцрЃљрЃЊ',
    corrected: 'рЃАрЃљрЃ«рЃџрЃЌрЃљрЃю рЃЏрЃўрЃЋрЃћрЃЊрЃў рЃАрЃгрЃарЃљрЃцрЃљрЃЊ',
    explanation: 'рЃЋрЃўрЃЌрЃљрЃарЃћрЃЉрЃўрЃЌрЃў рЃњрЃљрЃарЃћрЃЏрЃЮрЃћрЃЉрЃљ рЃќрЃЏрЃюрЃљрЃАрЃЌрЃљрЃю рЃ░рЃљрЃарЃЏрЃЮрЃюрЃўрЃљрЃерЃўрЃљ.',
    focus: 'syntax'
  },
  {
    input: 'рЃњрЃўрЃЮрЃарЃњрЃЮ рЃгрЃљрЃЋрЃўрЃЊрЃљ рЃАрЃљрЃЏрЃАрЃљрЃ«рЃБрЃарЃљрЃЏрЃЊрЃћ',
    corrected: 'рЃњрЃўрЃЮрЃарЃњрЃЮ рЃгрЃљрЃЋрЃўрЃЊрЃљ рЃАрЃљрЃЏрЃАрЃљрЃ«рЃБрЃарЃерЃў',
    explanation: 'рЃЊрЃљрЃюрЃўрЃерЃюрЃБрЃџрЃћрЃЉрЃўрЃА рЃњрЃљрЃЏрЃЮрЃ«рЃљрЃбрЃЋрЃљ рЃЏрЃЮрЃўрЃЌрЃ«рЃЮрЃЋрЃА рЃџрЃЮрЃЎрЃљрЃбрЃўрЃЋрЃА -рЃерЃў.',
    focus: 'case'
  },
  {
    input: 'рЃЏрЃљрЃАрЃгрЃљрЃЋрЃџрЃћрЃЉрЃћрЃџрЃА рЃБрЃърЃљрЃАрЃБрЃ«рЃћрЃА рЃЏрЃЮрЃАрЃгрЃљрЃЋрЃџрЃћрЃћрЃЉрЃў',
    corrected: 'рЃЏрЃљрЃАрЃгрЃљрЃЋрЃџрЃћрЃЉрЃћрЃџрЃА рЃБрЃърЃљрЃАрЃБрЃ«рЃћрЃА рЃЏрЃЮрЃАрЃгрЃљрЃЋрЃџрЃћрЃћрЃЉрЃЏрЃљ',
    explanation: 'рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃўрЃА рЃЉрЃарЃБрЃюрЃЋрЃљ рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃўрЃА рЃљрЃдрЃАрЃљрЃюрЃўрЃерЃюрЃљрЃЋрЃљрЃЊ (-рЃЏрЃљ).',
    focus: 'case'
  },
  {
    input: 'рЃўрЃАрЃўрЃюрЃў рЃЉрЃћрЃЊрЃюрЃўрЃћрЃарЃў рЃЉрЃўрЃГрЃћрЃЉрЃўрЃљ',
    corrected: 'рЃўрЃАрЃўрЃюрЃў рЃЉрЃћрЃЊрЃюрЃўрЃћрЃарЃў рЃЉрЃўрЃГрЃћрЃЉрЃў рЃљрЃарЃўрЃљрЃю',
    explanation: 'рЃЏрЃарЃљрЃЋрЃџрЃЮрЃЉрЃўрЃЌ рЃАрЃБрЃЉрЃўрЃћрЃЦрЃбрЃА рЃАрЃГрЃўрЃарЃЊрЃћрЃЉрЃљ рЃќрЃЏрЃюрЃљ "рЃљрЃарЃўрЃљрЃю".',
    focus: 'agreement'
  },
  {
    input: 'рЃерЃћрЃю рЃ«рЃљрЃа рЃЎрЃљрЃарЃњрЃЮ рЃЏрЃћрЃњрЃЮрЃЉрЃљрЃарЃў',
    corrected: 'рЃерЃћрЃю рЃ«рЃљрЃа рЃЎрЃљрЃарЃњрЃў рЃЏрЃћрЃњрЃЮрЃЉрЃљрЃарЃў',
    explanation: 'рЃЏрЃўрЃЏрЃљрЃарЃЌрЃЋрЃўрЃА рЃцрЃЮрЃарЃЏрЃљ "рЃЎрЃљрЃарЃњрЃЮ" рЃАрЃљрЃГрЃўрЃарЃЮ рЃљрЃарЃљрЃљ рЃБрЃфрЃЋрЃџрЃћрЃџ рЃќрЃћрЃЊрЃАрЃљрЃарЃЌрЃљрЃЋрЃЌрЃљрЃю.',
    focus: 'case'
  },
  {
    input: 'рЃћрЃА рЃљрЃарЃўрЃА рЃЉрЃљрЃ«рЃЏрЃљрЃарЃЮрЃА рЃЎрЃЮрЃбрЃћрЃ»рЃўрЃА рЃЎрЃљрЃарЃћрЃЉрЃў',
    corrected: 'рЃћрЃА рЃљрЃарЃўрЃА рЃЉрЃљрЃ«рЃЏрЃљрЃарЃЮрЃА рЃЎрЃЮрЃбрЃћрЃ»рЃўрЃА рЃЎрЃљрЃарЃў',
    explanation: 'рЃћрЃарЃЌрЃћрЃБрЃџрЃерЃў РђЊ рЃЎрЃљрЃарЃўрЃА рЃюрЃљрЃфрЃЋрЃџрЃљрЃЊ рЃЎрЃљрЃарЃў.',
    focus: 'spelling'
  },
  {
    input: 'рЃЕрЃЋрЃћрЃю рЃњрЃљрЃЋрЃљрЃЎрЃћрЃЌрЃћрЃЉрЃЌ рЃърЃарЃЮрЃћрЃЦрЃбрЃў рЃћрЃарЃЌрЃљрЃЊ',
    corrected: 'рЃЕрЃЋрЃћрЃю рЃњрЃљрЃЋрЃљрЃЎрЃћрЃЌрЃћрЃЉрЃЌ рЃърЃарЃЮрЃћрЃЦрЃбрЃА рЃћрЃарЃЌрЃљрЃЊ',
    explanation: 'рЃАрЃљрЃњрЃюрЃЮрЃЉрЃўрЃЌ рЃЮрЃЉрЃўрЃћрЃЦрЃбрЃў рЃЏрЃЮрЃўрЃЌрЃ«рЃЮрЃЋрЃА -рЃА рЃАрЃБрЃцрЃўрЃЦрЃАрЃА.',
    focus: 'case'
  },
  {
    input: 'рЃЊрЃљрЃџрЃћрЃЋ рЃДрЃљрЃЋрЃљрЃА?',
    corrected: 'рЃЊрЃљрЃџрЃћрЃЋ рЃДрЃљрЃЋрЃљрЃА?',
    explanation: 'рЃЏрЃћрЃЮрЃарЃћ рЃърЃўрЃарЃўрЃА рЃЏрЃЮрЃЏрЃљрЃЋрЃљрЃџрЃў рЃцрЃЮрЃарЃЏрЃљ рЃАрЃгрЃЮрЃарЃўрЃљ.',
    focus: 'syntax'
  },
  {
    input: 'рЃЌрЃўрЃюрЃљрЃЏ рЃўрЃДрЃўрЃЊрЃљ рЃгрЃўрЃњрЃюрЃћрЃЉрЃў',
    corrected: 'рЃЌрЃўрЃюрЃљрЃЏ рЃўрЃДрЃўрЃЊрЃљ рЃгрЃўрЃњрЃюрЃћрЃЉрЃў',
    explanation: 'рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃљрЃЊ рЃњрЃљрЃЏрЃљрЃарЃЌрЃБрЃџрЃў рЃгрЃўрЃюрЃљрЃЊрЃљрЃЊрЃћрЃЉрЃљ.',
    focus: 'syntax'
  },
  {
    input: 'рЃЉрЃљрЃЋрЃерЃЋрЃў рЃгрЃљрЃЋрЃўрЃЊрЃљ рЃАрЃљрЃ«рЃџрЃќрЃћ',
    corrected: 'рЃЉрЃљрЃЋрЃерЃЋрЃў рЃгрЃљрЃЋрЃўрЃЊрЃљ рЃАрЃљрЃ«рЃџрЃерЃў',
    explanation: 'рЃЊрЃљрЃюрЃўрЃерЃюрЃБрЃџрЃћрЃЉрЃўрЃА рЃљрЃдрЃАрЃљрЃюрЃўрЃерЃюрЃљрЃЋрЃљрЃЊ рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћрЃЌ -рЃерЃў.',
    focus: 'case'
  },
  {
    input: 'рЃЏрЃљрЃЌ рЃЏрЃЮрЃЋрЃўрЃЊрЃюрЃћрЃю рЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ',
    corrected: 'рЃўрЃАрЃўрЃюрЃў рЃЏрЃЮрЃЋрЃўрЃЊрЃюрЃћрЃю рЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ',
    explanation: 'рЃЏрЃљрЃЌ рЃљрЃарЃўрЃА рЃЊрЃљрЃЌ. рЃЉрЃарЃБрЃюрЃЋрЃљ; рЃАрЃБрЃЉрЃўрЃћрЃЦрЃбрЃўрЃАрЃЌрЃЋрЃўрЃА рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћрЃЌ рЃўрЃАрЃўрЃюрЃў.',
    focus: 'case'
  }
];

class GeorgianMorphModel {
  constructor(private dataset: GrammarDatasetEntry[]) {}

  scoreSequence(words: string[]): number {
    if (!words.length) return 0;
    const matches = words.filter(word =>
      this.dataset.some(example => example.corrected.includes(word))
    ).length;
    return Math.min(1, matches / words.length + 0.2);
  }

  suggestCorrection(words: string[]): string | null {
    const joined = words.join(' ');
    const candidate = this.dataset.find(example => example.input === joined);
    return candidate?.corrected ?? null;
  }
}

export class GeorgianGrammarParser {
  private mlModel = new GeorgianMorphModel(GEORGIAN_GRAMMAR_DATASET);

  parseSentence(sentence: string, options: GrammarParserOptions = {}): GeorgianParseResult {
    const tokens = this.tokenize(sentence, options.preserveEnglishTerms !== false);
    const morphTokens = tokens.map(token => this.analyzeToken(token));
    const syntaxTree = this.buildSyntaxTree(morphTokens);

    const errors: GeorgianGrammarError[] = [];

    this.detectCaseErrors(morphTokens, errors);
    this.detectAgreementIssues(morphTokens, errors);
    this.detectSyntaxIssues(morphTokens, syntaxTree, errors);

    const suggestions = this.buildSuggestions(tokens, morphTokens, errors, options);
    const correctedTokens = this.applySuggestions(tokens, suggestions);

    const mlCorrection = this.mlModel.suggestCorrection(tokens);
    if (mlCorrection && options.strict) {
      return {
        tokens: morphTokens,
        syntaxTree,
        errors,
        suggestions,
        correctedText: mlCorrection,
        datasetExamples: GEORGIAN_GRAMMAR_DATASET
      };
    }

    const correctedText = correctedTokens.join(' ').replace(/\s+([,.!?;])/g, '$1');

    return {
      tokens: morphTokens,
      syntaxTree,
      errors,
      suggestions,
      correctedText,
      datasetExamples: GEORGIAN_GRAMMAR_DATASET
    };
  }

  private tokenize(sentence: string, preserveEnglishTerms: boolean): string[] {
    if (!sentence) return [];
    const tokens = sentence
      .replace(/([,.!?;])/g, ' $1 ')
      .split(/\s+/)
      .filter(Boolean);

    if (preserveEnglishTerms) {
      return tokens.map(token => {
        if (/^[A-Za-z0-9_]+$/.test(token)) {
          return token;
        }
        return token;
      });
    }

    return tokens;
  }

  private analyzeToken(token: string): GeorgianMorphologicalToken {
    const normalized = token.replace(/[^\u10A0-\u10FFa-zA-Z0-9]/g, '');
    const base: GeorgianMorphologicalToken = {
      original: token,
      normalized,
      lemma: normalized,
      partOfSpeech: 'unknown',
      rootConfidence: 0.3,
      mlScore: 0
    };

    if (!normalized) {
      return base;
    }

    if (/^[A-Za-z0-9]+$/.test(normalized)) {
      return {
        ...base,
        partOfSpeech: 'unknown',
        lemma: normalized,
        notes: ['рЃўрЃюрЃњрЃџрЃўрЃАрЃБрЃарЃў рЃљрЃю рЃбрЃћрЃЦрЃюрЃўрЃЎрЃБрЃарЃў рЃбрЃћрЃарЃЏрЃўрЃюрЃў рЃерЃћрЃюрЃљрЃарЃЕрЃБрЃюрЃћрЃЉрЃБрЃџрЃўрЃљ.']
      };
    }

    if (COMMON_PRONOUNS[normalized]) {
      const pronoun = COMMON_PRONOUNS[normalized];
      return {
        ...base,
        partOfSpeech: 'pronoun',
        lemma: normalized,
        person: pronoun.person,
        number: pronoun.number,
        rootConfidence: 0.95,
        mlScore: 0.9
      };
    }

    const verbPattern = VERB_PATTERNS.find(pattern =>
      pattern.forms.includes(normalized)
    );

    if (verbPattern) {
      const guess = verbPattern.personGuesses.find(entry =>
        entry.startsWith === '' ? true : normalized.startsWith(entry.startsWith)
      );
      return {
        ...base,
        partOfSpeech: 'verb',
        lemma: verbPattern.lemma,
        tense: verbPattern.tense,
        person: guess?.person,
        rootConfidence: 0.85,
        mlScore: 0.88
      };
    }

    const detectedCase = this.detectCase(normalized);

    if (detectedCase) {
      const number = /рЃћрЃЉрЃў$|рЃћрЃЉрЃўрЃЌ$|рЃћрЃЉрЃА$/.test(normalized) ? 'plural' : 'singular';
      return {
        ...base,
        partOfSpeech: 'noun',
        lemma: this.stripSuffix(normalized, detectedCase),
        case: detectedCase,
        number,
        rootConfidence: 0.7,
        mlScore: 0.75
      };
    }

    if (this.looksLikeAdjective(normalized)) {
      return {
        ...base,
        partOfSpeech: 'adjective',
        lemma: normalized.replace(/(рЃў|рЃћ|рЃБрЃџрЃў|рЃБрЃарЃў|рЃБрЃџрЃў)$/g, ''),
        rootConfidence: 0.65,
        mlScore: 0.7
      };
    }

    return base;
  }

  private detectCase(word: string): GeorgianCase | undefined {
    for (const rule of GEORGIAN_CASE_RULES) {
      if (rule.suffixes.some(suffix => suffix && word.endsWith(suffix))) {
        return rule.case;
      }
    }

    if (/[рЃљ-рЃ░]+рЃА$/.test(word)) {
      return 'accusative';
    }

    return undefined;
  }

  private stripSuffix(word: string, caseType: GeorgianCase): string {
    const rule = GEORGIAN_CASE_RULES.find(entry => entry.case === caseType);
    if (!rule) return word;

    const suffix = rule.suffixes.find(suffix => suffix && word.endsWith(suffix));
    if (!suffix) return word;
    return word.slice(0, word.length - suffix.length);
  }

  private looksLikeAdjective(word: string): boolean {
    return ADJECTIVE_AGREEMENT_RULES.some(rule =>
      rule.singular.some(suffix => word.endsWith(suffix)) ||
      rule.plural.some(suffix => word.endsWith(suffix))
    );
  }

  private buildSyntaxTree(tokens: GeorgianMorphologicalToken[]): GeorgianSyntaxNode[] {
    const subjectTokens = tokens.filter(token =>
      token.partOfSpeech === 'pronoun' || (token.partOfSpeech === 'noun' && token.case !== 'dative')
    );
    const predicateTokens = tokens.filter(token => token.partOfSpeech === 'verb');
    const objectTokens = tokens.filter(token => token.case === 'accusative' || token.case === 'dative');

    const tree: GeorgianSyntaxNode = {
      label: 'S',
      tokens: tokens.map(token => token.original),
      children: []
    };

    if (subjectTokens.length) {
      tree.children?.push({
        label: 'NP-SUBJ',
        tokens: subjectTokens.map(token => token.original)
      });
    }

    if (predicateTokens.length) {
      tree.children?.push({
        label: 'VP',
        tokens: predicateTokens.map(token => token.original)
      });
    }

    if (objectTokens.length) {
      tree.children?.push({
        label: 'NP-OBJ',
        tokens: objectTokens.map(token => token.original)
      });
    }

    return [tree];
  }

  private detectCaseErrors(tokens: GeorgianMorphologicalToken[], errors: GeorgianGrammarError[]): void {
    tokens.forEach(token => {
      if (token.partOfSpeech !== 'noun') return;

      if (token.original.includes('-рЃА')) {
        errors.push({
          type: 'case',
          token: token.original,
          message: 'рЃАрЃљрЃњрЃюрЃЮрЃЉрЃўрЃЌрЃў рЃАрЃБрЃцрЃўрЃЦрЃАрЃў -рЃА рЃ░рЃўрЃцрЃћрЃюрЃўрЃА рЃњрЃљрЃарЃћрЃерЃћ рЃўрЃгрЃћрЃарЃћрЃЉрЃљ.',
          severity: 'medium',
          rule: 'case.hyphenation',
          suggestion: token.original.replace('-', ''),
          confidence: 0.95
        });
      }

      if (token.case === 'dative' && !token.original.endsWith('рЃА') && !token.original.endsWith('рЃћрЃЉрЃА')) {
        errors.push({
          type: 'case',
          token: token.original,
          message: 'рЃЏрЃўрЃфрЃћрЃЏрЃўрЃЌрЃў рЃЉрЃарЃБрЃюрЃЋрЃљ рЃўрЃЌрЃ«рЃЮрЃЋрЃА рЃАрЃБрЃцрЃўрЃЦрЃАрЃА -рЃА рЃљрЃю -рЃћрЃЉрЃА.',
          severity: 'low',
          rule: 'case.dativeSuffix',
          suggestion: `${token.original}рЃА`,
          confidence: 0.7
        });
      }

      if (token.case === 'accusative' && !token.original.endsWith('рЃА')) {
        errors.push({
          type: 'case',
          token: token.original,
          message: 'рЃАрЃљрЃњрЃюрЃЮрЃЉрЃўрЃЌрЃў рЃЉрЃарЃБрЃюрЃЋрЃљ рЃЏрЃЮрЃўрЃЌрЃ«рЃЮрЃЋрЃА -рЃА рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃљрЃА.',
          severity: 'medium',
          rule: 'case.accusativeSuffix',
          suggestion: `${token.original}рЃА`,
          confidence: 0.75
        });
      }
    });
  }

  private detectAgreementIssues(tokens: GeorgianMorphologicalToken[], errors: GeorgianGrammarError[]): void {
    const subjects = tokens.filter(token => token.partOfSpeech === 'pronoun' || (token.partOfSpeech === 'noun' && token.case !== 'dative'));
    const verbs = tokens.filter(token => token.partOfSpeech === 'verb');

    if (!subjects.length || !verbs.length) return;

    const subject = subjects[0];
    const verb = verbs[0];

    if (subject.person && verb.person && subject.person !== verb.person) {
      errors.push({
        type: 'agreement',
        token: verb.original,
        message: 'рЃќрЃЏрЃюрЃўрЃА рЃърЃўрЃарЃў рЃБрЃюрЃЊрЃљ рЃЊрЃљрЃћрЃЏрЃЌрЃ«рЃЋрЃћрЃА рЃАрЃБрЃЉрЃўрЃћрЃЦрЃбрЃА.',
        severity: 'high',
        rule: 'agreement.person',
        suggestion: this.adjustVerbPerson(verb.original, subject.person),
        confidence: 0.9
      });
    }

    if (subject.number === 'plural' && (!verb.original.endsWith('рЃЌ') && !verb.original.endsWith('рЃюрЃћрЃю') && !verb.original.endsWith('рЃћрЃю'))) {
      errors.push({
        type: 'agreement',
        token: verb.original,
        message: 'рЃЏрЃарЃљрЃЋрЃџрЃЮрЃЉрЃўрЃЌрЃў рЃАрЃБрЃЉрЃўрЃћрЃЦрЃбрЃў рЃЏрЃЮрЃўрЃЌрЃ«рЃЮрЃЋрЃА рЃќрЃЏрЃюрЃўрЃА рЃЏрЃарЃљрЃЋрЃџрЃЮрЃЉрЃўрЃЌ рЃцрЃЮрЃарЃЏрЃљрЃА.',
        severity: 'high',
        rule: 'agreement.number',
        suggestion: verb.original + 'рЃЌ',
        confidence: 0.85
      });
    }
  }

  private adjustVerbPerson(verb: string, person: 1 | 2 | 3): string {
    if (person === 1 && !verb.startsWith('рЃЋ')) {
      return `рЃЋ${verb}`;
    }
    if (person === 2 && !verb.startsWith('рЃњ') && !verb.startsWith('рЃЊ')) {
      return `рЃњ${verb}`;
    }
    if (person === 3 && verb.startsWith('рЃЋ')) {
      return verb.slice(1);
    }
    return verb;
  }

  private detectSyntaxIssues(tokens: GeorgianMorphologicalToken[], syntaxTree: GeorgianSyntaxNode[], errors: GeorgianGrammarError[]): void {
    const tree = syntaxTree[0];
    if (!tree) return;

    const hasSubject = tree.children?.some(child => child.label === 'NP-SUBJ');
    const hasVerb = tree.children?.some(child => child.label === 'VP');

    if (!hasSubject || !hasVerb) {
      errors.push({
        type: 'syntax',
        token: tree.tokens.join(' '),
        message: 'рЃгрЃўрЃюрЃљрЃЊрЃљрЃЊрЃћрЃЉрЃљ рЃБрЃюрЃЊрЃљ рЃерЃћрЃўрЃфрЃљрЃЋрЃЊрЃћрЃА рЃАрЃБрЃЉрЃўрЃћрЃЦрЃбрЃАрЃљ рЃЊрЃљ рЃќрЃЏрЃюрЃљрЃА.',
        severity: 'medium',
        rule: 'syntax.svStructure',
        confidence: 0.6
      });
    }
  }

  private buildSuggestions(
    rawTokens: string[],
    morphTokens: GeorgianMorphologicalToken[],
    errors: GeorgianGrammarError[],
    options: GrammarParserOptions
  ): GeorgianGrammarSuggestion[] {
    const suggestions: GeorgianGrammarSuggestion[] = [];

    errors.forEach(error => {
      if (!error.suggestion) return;
      suggestions.push({
        message: error.message,
        replacement: error.suggestion,
        rule: error.rule,
        confidence: error.confidence
      });
    });

    const mlScore = this.mlModel.scoreSequence(rawTokens);
    if (mlScore < 0.65 && options.strict) {
      suggestions.push({
        message: 'рЃАрЃљрЃгрЃДрЃўрЃАрЃў рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃўрЃА рЃЏрЃўрЃ«рЃћрЃЊрЃЋрЃўрЃЌ рЃАрЃљрЃГрЃўрЃарЃЮрЃљ рЃгрЃўрЃюрЃљрЃЊрЃљрЃЊрЃћрЃЉрЃўрЃА рЃАрЃарЃБрЃџрЃў рЃњрЃљрЃЊрЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ.',
        rule: 'ml.review',
        confidence: 0.5
      });
    }

    if (!suggestions.length && morphTokens.length > 0) {
      suggestions.push({
        message: 'рЃгрЃўрЃюрЃљрЃЊрЃљрЃЊрЃћрЃЉрЃљ рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃљрЃЊ рЃАрЃгрЃЮрЃарЃўрЃљ.',
        rule: 'validation.ok',
        confidence: 0.8
      });
    }

    return suggestions;
  }

  private applySuggestions(tokens: string[], suggestions: GeorgianGrammarSuggestion[]): string[] {
    const replacements = new Map<string, string>();
    suggestions.forEach(suggestion => {
      if (suggestion.replacement) {
        replacements.set(suggestion.rule, suggestion.replacement);
      }
    });

    return tokens.map(token => {
      if (token.includes('-рЃА')) {
        return token.replace('-', '');
      }

      if (replacements.has('agreement.number')) {
        const replacement = replacements.get('agreement.number')!;
        if (/рЃЋ\w+/.test(token)) {
          return replacement;
        }
      }

      return token;
    });
  }
}

export default GeorgianGrammarParser;
