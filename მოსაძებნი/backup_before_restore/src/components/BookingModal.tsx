import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { useParams } from 'react-router-dom';
import { collection, query, where, getDocs, addDoc, doc, getDoc, limit } from 'firebase/firestore';
import { db } from '../firebaseConfig';
import { X, Calendar, Users, Phone, User, Clock, Lock, Home, CreditCard } from 'lucide-react';
import { calculateSeasonalPrice, type PricingResult } from '../utils/pricing';
import { getActivePrice } from '../types/seasonalPricing';
import { checkUserExists, registerCustomerDuringBooking } from '../services/userService';
import CustomCalendar from './Calendar';
import BookingAuth from './BookingAuth';
import ConfirmationModal from './ConfirmationModal';
import { validatePriceCode } from '../services/priceCodeService';
import { useAuth } from '../contexts/AuthContext';
import { useValidation } from '../hooks/useValidation';
import ValidationModal from './ValidationModal';
import { useDebugLogging } from '../hooks/useDebugLogging';

interface BookingData {
  firstName: string;
  lastName: string;
  personalId: string;
  phone: string;
  password: string;
  adults: number;
  children: number;
  cottage: string;
  startDate: Date | null;
  endDate: Date | null;
  arrivalTime: string;
  departureTime: string;
  notes: string;
  useCustomPrice: boolean;
  customTotalPrice: number | null;
  ·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éò·Éö·Éò·Éê: boolean;
}

interface BookingModalProps {
  cottageId: string;
  cottageName: string;
  isOpen: boolean;
  onClose: () => void;
  booking?: any;
  mode: 'create' | 'edit' | 'view';
  onBookingUpdated?: () => void;
}

export default function BookingModal({ cottageId, cottageName, isOpen, onClose, booking, mode, onBookingUpdated }: BookingModalProps) {
  // Use cottageId from props - it should always be provided when modal is opened
  const finalCottageId = cottageId;
  const { user: authUser } = useAuth();
  const { validationErrors, isValidationModalOpen, hideValidationErrors, validateAndProceed } = useValidation();
  const { logModal, logInfo, logValidation, logError } = useDebugLogging('BookingModal');

  console.log('üè† BookingModal received cottage ID:', cottageId);
  console.log('üè† Final cottage ID:', finalCottageId);

  // Early return if no cottage ID
  if (!cottageId) {
    console.error('‚ùå BookingModal: No cottage ID provided!');
    return null;
  }

  const [bookedDates, setBookedDates] = useState<Date[]>([]);
  const [loading, setLoading] = useState(false);
  const [pricing, setPricing] = useState<PricingResult | null>(null);
  const [showAuthModal, setShowAuthModal] = useState(false);
  const [authenticatedUser, setAuthenticatedUser] = useState<any>(null);
  const [showPasswordField, setShowPasswordField] = useState(false);
  const [userCheckPerformed, setUserCheckPerformed] = useState(false);
  const [showExistingUserBanner, setShowExistingUserBanner] = useState(false);

  // Price code states
  const [priceCode, setPriceCode] = useState('');
  const [isCodeValid, setIsCodeValid] = useState(false);
  const [codeValidationError, setCodeValidationError] = useState('');
  const [isValidatingCode, setIsValidatingCode] = useState(false);

  // Confirmation modal state
  const [showConfirmationModal, setShowConfirmationModal] = useState(false);
  const [bookingConfirmationData, setBookingConfirmationData] = useState<any>(null);
  const [bookingSuccess, setBookingSuccess] = useState(false);
  const [cottage, setCottage] = useState<any>(null);

  const [form, setForm] = useState<BookingData>({
    firstName: '',
    lastName: '',
    personalId: '',
    phone: '',
    password: '',
    adults: 1,
    children: 0,
    cottage: cottageId || '',
    startDate: null,
    endDate: null,
    arrivalTime: '14:00',
    departureTime: '12:00',
    notes: '',
    useCustomPrice: false,
    customTotalPrice: null,
    ·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éò·Éö·Éò·Éê: false
  });

  // Update cottage field when cottageId changes
  useEffect(() => {
    if (cottageId) {
      setForm(prev => ({ ...prev, cottage: cottageId }));
    }
  }, [cottageId]);

  // Auto-set authenticated user if authUser exists
  useEffect(() => {
    if (authUser) {
      setAuthenticatedUser(authUser);
      setForm(prev => ({
        ...prev,
        firstName: authUser.firstName || '',
        lastName: authUser.lastName || '',
        phone: authUser.phoneNumber || authUser.email || '',
        personalId: authUser.personalId || ''
      }));
      setUserCheckPerformed(true);
      setShowPasswordField(false);
    }
  }, [authUser]);

  useEffect(() => {
    const fetchCottage = async () => {
      if (cottageId) {
        try {
          const cottageDoc = await getDoc(doc(db, 'cottages', cottageId));
          if (cottageDoc.exists()) {
            setCottage(cottageDoc.data());
          } else {
            console.log('No such cottage!');
          }
        } catch (error) {
          console.error('Error fetching cottage:', error);
        }
      }
    };

    fetchCottage();
  }, [cottageId]);

  // ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·É£·Éö·Éò ·Éó·Éê·É†·Éò·É¶·Éî·Éë·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê
  useEffect(() => {
    if (!isOpen || !cottageId) return;

    const fetchBookedDates = async () => {
      try {
        const q = query(
          collection(db, 'bookings'), 
          where('cottage', '==', cottageId),
          where('·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éò·Éö·Éò·Éê', '==', true),
          limit(100)
        );
        const snap = await getDocs(q);
        const dates: Date[] = [];

        snap.forEach(doc => {
          const data = doc.data();
          const startDate = data.startDate.toDate();
          const endDate = data.endDate.toDate();

          for (let d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) {
            dates.push(new Date(d));
          }
        });

        setBookedDates(dates);
      } catch (error) {
        console.error('Error fetching booked dates:', error);
      }
    };

    fetchBookedDates();
  }, [isOpen, cottageId]);

  // ·É§·Éê·É°·Éò·É° ·Éí·Éê·Éõ·Éù·Éó·Éï·Éö·Éê - now uses actual cottage data for accurate base pricing
  useEffect(() => {
    if (form.startDate && form.endDate && form.adults && form.endDate > form.startDate && cottage) {
      const pricingResult = calculateSeasonalPrice(
        form.startDate,
        form.endDate,
        form.adults,
        form.children,
        form.useCustomPrice,
        form.customTotalPrice,
        cottage // Pass cottage object to get accurate base price via getActivePrice()
      );
      setPricing(pricingResult);
    }
  }, [form.startDate, form.endDate, form.adults, form.children, form.useCustomPrice, form.customTotalPrice, cottage]);

  // Validate price code
  const validateCode = async () => {
    if (!priceCode.trim()) {
      setCodeValidationError('·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éî·Éó ·Éô·Éù·Éì·Éò');
      return;
    }

    if (!cottageId) {
      setCodeValidationError('·Éô·Éù·É¢·Éî·ÉØ·Éò·É° ID ·Éê·É† ·Éê·É†·Éò·É° ·Éõ·Éò·Éó·Éò·Éó·Éî·Éë·É£·Éö·Éò');
      return;
    }

    setIsValidatingCode(true);
    setCodeValidationError('');

    try {
      const result = await validatePriceCode(priceCode.trim(), cottageId);

      if (result.isValid) {
        setIsCodeValid(true);
        setCodeValidationError('');
        setForm(prev => ({ ...prev, useCustomPrice: true }));
        console.log('‚úÖ ·Éô·Éù·Éì·Éò ·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·É£·Éö·Éò·Éê - ·Éò·Éú·Éì·Éò·Éï·Éò·Éì·É£·Éê·Éö·É£·É†·Éò ·É§·Éê·É°·Éò·É° ·Éï·Éî·Éö·Éò ·Éí·Éê·Éê·É•·É¢·Éò·É£·É†·Éì·Éê');
      } else {
        setIsCodeValid(false);
        setCodeValidationError(result.error || '·Éô·Éù·Éì·Éò ·Éê·É†·Éê·É°·É¨·Éù·É†·Éò·Éê');
        setForm(prev => ({ ...prev, useCustomPrice: false, customTotalPrice: null }));
      }
    } catch (error: any) {
      console.error('‚ùå Error validating code:', error);
      setCodeValidationError('·Éô·Éù·Éì·Éò·É° ·É®·Éî·Éõ·Éù·É¨·Éõ·Éî·Éë·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê');
      setIsCodeValid(false);
    } finally {
      setIsValidatingCode(false);
    }
  };


  // ·Éû·Éê·É†·Éù·Éö·Éò·É° ·Éï·Éê·Éö·Éò·Éì·Éê·É™·Éò·Éò·É° ·É§·É£·Éú·É•·É™·Éò·Éê
  const validatePassword = (password: string): { isValid: boolean; message: string } => {
    const passwordRegex = /^[A-Za-z0-9!@#$%^&*()_+=-]{6,}$/;

    if (!password) {
      return { isValid: false, message: "·Éû·Éê·É†·Éù·Éö·Éò ·É°·Éê·Éï·Éê·Éö·Éì·Éî·Éë·É£·Éö·Éù·Éê" };
    }

    if (password.length < 6) {
      return { isValid: false, message: "·Éû·Éê·É†·Éù·Éö·Éò ·É£·Éú·Éì·Éê ·É®·Éî·Éò·É™·Éê·Éï·Éì·Éî·É° ·Éõ·Éò·Éú·Éò·Éõ·É£·Éõ 6 ·É°·Éò·Éõ·Éë·Éù·Éö·Éù·É°" };
    }

    if (!passwordRegex.test(password)) {
      return { isValid: false, message: "·Éû·Éê·É†·Éù·Éö·Éò ·É£·Éú·Éì·Éê ·É®·Éî·Éò·É™·Éê·Éï·Éì·Éî·É° ·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·Éò·Éú·Éí·Éö·Éò·É°·É£·É† ·Éê·É°·Éù·Éî·Éë·É°, ·É™·Éò·É§·É†·Éî·Éë·É° ·Éì·Éê ·Éõ·Éò·Éó·Éò·Éó·Éî·Éë·É£·Éö ·É°·Éû·Éî·É™·Éò·Éê·Éö·É£·É† ·É°·Éò·Éõ·Éë·Éù·Éö·Éù·Éî·Éë·É°" };
    }

    return { isValid: true, message: "" };
  };

  const handleChange = async (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    console.log(`üìù Field changed: ${name} = ${value}`);

    setForm(prev => ({
      ...prev,
      [name]: name === 'adults' || name === 'children'
        ? Number(value)
        : value
    }));

    // ·Éû·Éê·É†·Éù·Éö·Éò·É° ·Éï·Éê·Éö·Éò·Éì·Éê·É™·Éò·Éê real-time-·É®·Éò
    if (name === 'password' && value) {
      const validation = validatePassword(value);
      if (!validation.isValid) {
        console.warn(`‚ö†Ô∏è Password validation failed: ${validation.message}`);
      }
    }

    if (name === 'phone' || name === 'personalId') {
      console.log(`üîç Checking user existence for ${name}: ${value}`);
      setUserCheckPerformed(false);
      setShowPasswordField(false);
      setShowAuthModal(false);
      setAuthenticatedUser(null);
      setShowExistingUserBanner(false);

      if (value.length > 5) {
        setTimeout(async () => {
          const updatedForm = { ...form, [name]: value };
          if (updatedForm.phone.length > 5 || updatedForm.personalId.length > 5) {
            try {
              console.log(`üìû Checking if user exists with phone: ${updatedForm.phone}, personalId: ${updatedForm.personalId}`);
              const userCheckResult = await checkUserExists(updatedForm.phone, updatedForm.personalId);
              console.log("checkUserExists result:", userCheckResult);

              if (userCheckResult.exists) {
                console.log(`‚úÖ Existing user found:`, userCheckResult);
                setShowExistingUserBanner(true);
                setShowAuthModal(true);
                setUserCheckPerformed(true);
              } else {
                console.log(`üÜï New user - showing password field`);
                setShowPasswordField(true);
                setUserCheckPerformed(true);
                setShowExistingUserBanner(false);
              }
            } catch (error: any) {
        console.error('‚ùå Error checking user existence:', error);
        console.error('‚ùå Error details:', error.message);
        console.error('‚ùå Stack trace:', error.stack);
        setShowPasswordField(true);
        setUserCheckPerformed(true);
        alert('·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éò·É° ·É®·Éî·Éõ·Éù·É¨·Éõ·Éî·Éë·Éò·É° ·Éì·É†·Éù·É° ·Éõ·Éù·ÉÆ·Éì·Éê ·É®·Éî·É™·Éì·Éù·Éõ·Éê. ·É°·É™·Éê·Éì·Éî·Éó ·ÉÆ·Éî·Éö·Éê·ÉÆ·Éö·Éê');
      }
          }
        }, 500);
      }
    }
  };

  const handleAuthSuccess = (user: any) => {
    setAuthenticatedUser(user);
    setShowAuthModal(false);
    setShowExistingUserBanner(false);
    setForm(prev => ({
      ...prev,
      firstName: user.firstName,
      lastName: user.lastName,
      phone: user.phoneNumber || prev.phone,
      personalId: user.personalId || prev.personalId
    }));
  };

  const handleDateChange = (field: 'startDate' | 'endDate', date: Date | null) => {
    if (date) {
      setForm(prev => ({ ...prev, [field]: date }));
    }
  };

  // Cache booked dates set for better performance
  const bookedDatesSet = useMemo(() => {
    return new Set(bookedDates.map(date => date.toDateString()));
  }, [bookedDates]);

  const isDateAvailable = useCallback((date: Date) => {
    return !bookedDatesSet.has(date.toDateString());
  }, [bookedDatesSet]);

  const isRangeOverlappingWithBookedDates = useCallback((rangeStart: Date, rangeEnd: Date): boolean => {
    for (let d = new Date(rangeStart); d <= rangeEnd; d.setDate(d.getDate() + 1)) {
      if (bookedDatesSet.has(d.toDateString())) {
        return true; // Overlap found
      }
    }
    return false; // No overlap
  }, [bookedDatesSet]);

  const resetForm = () => {
    setForm({
      firstName: '',
      lastName: '',
      personalId: '',
      phone: '',
      password: '',
      adults: 1,
      children: 0,
      cottage: cottageId || '',
      startDate: null,
      endDate: null,
      arrivalTime: '14:00',
      departureTime: '12:00',
      notes: '',
      useCustomPrice: false,
      customTotalPrice: null,
      ·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éò·Éö·Éò·Éê: false
    });
    setPricing(null);
    setPriceCode('');
    setIsCodeValid(false);
    setCodeValidationError('');
  };

  const createTemporaryBlock = async (
    cottageId: string,
    startDate: Date,
    endDate: Date,
    customerName: string,
    customerPhone: string,
    bookingId: string
  ) => {
    // Logic to create a temporary block (e.g., in Firestore or a cache)
    // This is a placeholder, replace with your actual implementation
    console.log(
      `Creating temporary block for cottage ${cottageId} from ${startDate} to ${endDate} for customer ${customerName} (${customerPhone}) with booking ID ${bookingId}`
    );

    // In a real implementation, you might:
    // 1. Add a document to a "temporaryBlocks" collection in Firestore
    // 2. Store the block information in a cache (e.g., Redis)

    // Example using Firestore:
    try {
      await addDoc(collection(db, 'temporaryBlocks'), {
        cottageId: cottageId,
        startDate: startDate,
        endDate: endDate,
        customerName: customerName,
        customerPhone: customerPhone,
        bookingId: bookingId,
        createdAt: new Date(),
        expiresAt: new Date(Date.now() + 15 * 60 * 1000), // 15 minutes from now
      });
      console.log('‚úÖ Temporary block created in Firestore');
    } catch (error) {
      console.error('‚ùå Error creating temporary block in Firestore:', error);
      throw error; // Re-throw the error to be caught by the handleSubmit function
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    console.log('üöÄ Starting booking submission process');

    const proceedWithBooking = async () => {
      // Additional booking-specific validations
      if (!authenticatedUser && showPasswordField) {
        if (!form.password) {
          alert('·Éí·Éó·ÉÆ·Éù·Éï ·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éî ·Éû·Éê·É†·Éù·Éö·Éò ·É†·Éî·Éí·Éò·É°·É¢·É†·Éê·É™·Éò·Éò·É°·Éó·Éï·Éò·É°');
          return;
        }

        const passwordValidation = validatePassword(form.password);
        if (!passwordValidation.isValid) {
          alert(`·Éû·Éê·É†·Éù·Éö·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ${passwordValidation.message}`);
          return;
        }
      }

      setLoading(true);

      try {
        // calculates the number of nights
        const calculateNights = () => {
          if (!form.startDate || !form.endDate) return 0;
          const diff = form.endDate.getTime() - form.startDate.getTime();
          return Math.ceil(diff / (1000 * 3600 * 24));
        };

        // Calculate final pricing values with logging
        const numberOfDays = calculateNights();
        const finalTotalPrice = form.useCustomPrice && form.customTotalPrice 
          ? form.customTotalPrice 
          : pricing?.totalPrice || 0;
        const finalDepositAmount = pricing?.depositAmount || Math.ceil(finalTotalPrice * 0.3);
        const remainingAmount = finalTotalPrice - finalDepositAmount;

        console.log(`üßÆ Modal booking price calculated: ${numberOfDays} days * rate = ${finalTotalPrice} ‚Çæ`);
        console.log(`üí∞ Modal deposit amount: ${finalDepositAmount} ‚Çæ`);
        console.log(`üí≥ Modal remaining amount: ${remainingAmount} ‚Çæ`);
        console.log('üíæ Creating booking in Firestore...');

        console.log(`üßÆ Modal booking price calculated: ${numberOfDays} days * rate = ${finalTotalPrice} ‚Çæ`);
        console.log(`üí∞ Modal deposit amount: ${finalDepositAmount} ‚Çæ`);
        console.log(`üí≥ Modal remaining amount: ${remainingAmount} ‚Çæ`);

        // Ensure we have a valid user before creating booking
        let validUserId = authenticatedUser?.id;

        if (!validUserId && form.password) {
          console.log('üîÑ No existing user found, creating new user...');

          // Create new user first
          try{
            const newUser = await registerCustomerDuringBooking({
              firstName: form.firstName,
              lastName: form.lastName,
              phoneNumber: form.phone,
              personalId: form.personalId,
              password: form.password || 'bakhmaro2024',
            });

            validUserId = newUser.id;
            console.log('‚úÖ New user created with ID:', validUserId);
          } catch(error){
            console.error("Error creating user", error)
          }

        }

        const now = new Date();
        const expiresAt = new Date(now.getTime() + 15 * 60 * 1000); // 15 ·É¨·É£·Éó·Éò

        const bookingData = {
          ...form,
          cottage: cottageId, // Ensure cottage field is set correctly
          userId: validUserId,
          customerId: validUserId, // Use the valid user ID
          createdAt: now,
          expiresAt: expiresAt,
          status: 'pending', // ·É®·Éî·É™·Éï·Éö·Éò·Éö·Éò confirmed-·Éì·Éê·Éú pending-·Éñ·Éî
          // Pricing - Always save all pricing values for admin view
          totalPrice: finalTotalPrice,
          depositAmount: finalDepositAmount,
          remainingAmount: remainingAmount,
          calculatedDays: calculateNights(),
          dailyRate: calculateNights() > 0 ? Math.round(finalTotalPrice / calculateNights()) : 0,
          useCustomPrice: form.useCustomPrice,
          customTotalPrice: form.useCustomPrice ? form.customTotalPrice : null,
        };

        // Final validation of booking payload
        if (!bookingData.cottage) {
          console.error('‚ùå Missing cottage field in booking payload');
          alert('·Éô·Éù·É¢·Éî·ÉØ·Éò·É° ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éê ·Éê·É† ·Éê·É†·Éò·É° ·Éõ·Éò·Éó·Éò·Éó·Éî·Éë·É£·Éö·Éò. ·É°·É™·Éê·Éì·Éî·Éó ·ÉÆ·Éî·Éö·Éê·ÉÆ·Éö·Éê');
          return;
        }

        console.log('üì¶ Booking Payload:', bookingData);

        // ·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·É®·Éî·É•·Éõ·Éú·Éê
        try {
          const docRef = await addDoc(collection(db, 'bookings'), bookingData);

          console.log('‚úÖ Booking created successfully with ID:', docRef.id);

          // ·Éì·É†·Éù·Éî·Éë·Éò·Éó·Éò ·Éë·Éö·Éù·Éô·Éò·É° ·É®·Éî·É•·Éõ·Éú·Éê 15 ·É¨·É£·Éó·Éò·Éó
          try {
            await createTemporaryBlock(
              cottageId,
              form.startDate!,
              form.endDate!,
              `${form.firstName} ${form.lastName}`,
              form.phone,
              docRef.id
            );
            console.log('‚úÖ Temporary block created for 15 minutes');
          } catch (blockError) {
            console.error('‚ùå Failed to create temporary block:', blockError);
            // ·ÉØ·Éê·Éï·É®·Éê·Éú·Éò ·Éõ·Éê·Éò·Éú·É™ ·É®·Éî·Éú·Éê·ÉÆ·Éî·É°, ·Éõ·Éê·Éí·É†·Éê·Éõ ·Éë·Éö·Éù·Éô·Éò ·Éê·É† ·É®·Éî·Éò·É•·Éõ·Éú·Éê
          }

          // ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·É° ·Éõ·Éù·Éì·Éê·Éö·Éò·É° ·É©·Éï·Éî·Éú·Éî·Éë·Éê
          setBookingSuccess(true);
          setShowConfirmationModal(true);
          // ·É®·Éî·Éï·É•·Éõ·Éú·Éê·Éó confirmation modal-·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò
          setBookingConfirmationData({
            cottageId: cottageId,
            cottageName: cottageName,
            startDate: form.startDate,
            endDate: form.endDate,
            adults: form.adults,
            children: form.children,
            totalPrice: finalTotalPrice,
            depositAmount: finalDepositAmount,
            customTotalPrice: form.useCustomPrice ? form.customTotalPrice : null,
            useCustomPrice: form.useCustomPrice,
            firstName: form.firstName,
            lastName: form.lastName,
            phone: form.phone,
            personalId: form.personalId,
            notes: form.notes,
            customerName: `${form.firstName} ${form.lastName}`
          });

          onSuccess();
        } catch (bookingError: any) {
          console.error('‚ùå Booking creation failed:', bookingError);
          console.error('‚ùå Full error object:', bookingError);
          alert('·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·É®·Éî·É•·Éõ·Éú·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê. ·É°·É™·Éê·Éì·Éî·Éó ·ÉÆ·Éî·Éö·Éê·ÉÆ·Éö·Éê');
        }

      } catch (error: any) {
        console.error('‚ùå Unexpected error during booking submission:', error);
        alert('·Éõ·Éù·ÉÆ·Éì·Éê ·Éõ·Éù·É£·Éö·Éù·Éì·Éú·Éî·Éö·Éò ·É®·Éî·É™·Éì·Éù·Éõ·Éê. ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É°·É™·Éê·Éì·Éù·Éó ·ÉÆ·Éî·Éö·Éê·ÉÆ·Éö·Éê');
      } finally {
        setLoading(false);
        console.log('üèÅ Booking submission process completed');
      }
    };

    // Use global validation service
    validateAndProceed(form, 'booking', proceedWithBooking);
  };

  const onSuccess = () => {
    // Handle successful booking
    console.log('Booking submission completed successfully');
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between rounded-t-2xl">
          <div>
            <h2 className="text-2xl font-bold text-gray-800">
            {mode === 'view' ? '·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·Éì·Éî·É¢·Éê·Éö·Éî·Éë·Éò' : 
             mode === 'edit' ? '·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·É†·Éî·Éì·Éê·É•·É¢·Éò·É†·Éî·Éë·Éê' : 
             '·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·Éí·Éê·É§·Éù·É†·Éõ·Éî·Éë·Éê'}
             </h2>
            <p className="text-gray-600">{cottageName}</p>
          </div>
          <button
            onClick={onClose}
            className="p-2 hover:bg-gray-100 rounded-full transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Existing User Banner */}
        {showExistingUserBanner && (
          <div className="mx-6 mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div className="flex items-start">
              <div className="text-blue-600 mr-3 text-lg">‚ÑπÔ∏è</div>
              <div>
                <h4 className="text-blue-800 font-semibold mb-1">·Éó·É•·Éï·Éî·Éú ·É£·Éô·Éï·Éî ·É†·Éî·Éí·Éò·É°·É¢·É†·Éò·É†·Éî·Éë·É£·Éö·Éò ·ÉÆ·Éê·É†·Éó</h4>
                <p className="text-blue-700 text-sm">
                  ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éí·Éê·Éò·Éê·É†·Éî·Éó ·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éê·É™·Éò·Éê ·É®·Éî·É°·Éê·É°·Éï·Éö·Éî·Éö·Éê·Éì ·Éì·Éê ·É®·Éî·Éõ·Éì·Éî·Éí ·Éí·Éê·Éú·Éê·ÉÆ·Éù·É†·É™·Éò·Éî·Éö·Éî·Éó ·ÉØ·Éê·Éï·É®·Éê·Éú·Éò.
                </p>
              </div>
            </div>
          </div>
        )}

        <div className="p-6">
          <form onSubmit={handleSubmit} className="space-y-6">
            {/* ·Éû·Éò·É†·Éê·Éì·Éò ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éê - ·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·Éê·É†·Éê·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éî·Éë·É£·Éö·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éî·Éë·Éò·É°·Éó·Éï·Éò·É° */}
            {!authenticatedUser ? (
              <div className="bg-gray-50 p-6 rounded-xl">
                <h3 className="text-lg font-semibold mb-4 flex items-center">
                  <User className="w-5 h-5 mr-2" />
                  ·Éû·Éò·É†·Éê·Éì·Éò ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éê
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label htmlFor="firstName" className="block text-sm font-medium text-gray-700 mb-2">·É°·Éê·ÉÆ·Éî·Éö·Éò *</label>
                    <input
                      id="firstName"
                      name="firstName"
                      value={form.firstName}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      required
                      readOnly={mode === 'view'}
                    />
                  </div>
                  <div>
                    <label htmlFor="lastName" className="block text-sm font-medium text-gray-700 mb-2">·Éí·Éï·Éê·É†·Éò *</label>
                    <input
                      id="lastName"
                      name="lastName"
                      value={form.lastName}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      required
                      readOnly={mode === 'view'}
                    />
                  </div>
                  <div>
                    <label htmlFor="personalId" className="block text-sm font-medium text-gray-700 mb-2">·Éû·Éò·É†·Éê·Éì·Éò ·Éú·Éù·Éõ·Éî·É†·Éò *</label>
                    <input
                      id="personalId"
                      name="personalId"
                      value={form.personalId}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      required
                      readOnly={mode === 'view'}
                    />
                  </div>
                  <div>
                    <label htmlFor="phone" className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                      <Phone className="w-4 h-4 mr-1" />
                      ·É¢·Éî·Éö·Éî·É§·Éù·Éú·Éò *
                    </label>
                    <input
                      id="phone"
                      name="phone"
                      value={form.phone}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      required
                      readOnly={mode === 'view'}
                    />
                  </div>
                  {showPasswordField && (
                    <div className="col-span-2">
                      <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <Lock className="w-4 h-4 mr-1" />
                        ·Éû·Éê·É†·Éù·Éö·Éò * <span className="text-xs text-gray-500 ml-2">(·Éû·Éò·É†·Éï·Éî·Éö·Éò ·ÉØ·Éê·Éï·É®·Éú·Éò·É°·Éó·Éï·Éò·É°)</span>
                      </label>
                      <input
                        id="password"
                        type="password"
                        name="password"
                        value={form.password}
                        onChange={handleChange}
                        className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                          form.password && !validatePassword(form.password).isValid 
                            ? 'border-red-300 bg-red-50' 
                            : 'border-gray-300'
                        }`}
                        placeholder="·É®·Éî·É•·Éõ·Éî·Éú·Éò·Éó ·Éû·Éê·É†·Éù·Éö·Éò ·Éõ·Éù·Éõ·Éê·Éï·Éê·Éö·Éò ·ÉØ·Éê·Éï·É®·Éú·Éî·Éë·Éò·É°·Éó·Éï·Éò·É°"
                        required={showPasswordField}
                        readOnly={mode === 'view'}
                      />
                      {form.password && !validatePassword(form.password).isValid && (
                        <p className="mt-2 text-sm text-red-600">
                          {validatePassword(form.password).message}
                        </p>
                      )}
                      <div className="mt-2 text-xs text-gray-500">
                        <p>·Éû·Éê·É†·Éù·Éö·Éò ·É£·Éú·Éì·Éê ·É®·Éî·Éò·É™·Éê·Éï·Éì·Éî·É°:</p>
                        <ul className="list-disc list-inside ml-2 space-y-1">
                          <li>·Éõ·Éò·Éú·Éò·Éõ·É£·Éõ 6 ·É°·Éò·Éõ·Éë·Éù·Éö·Éù·É°</li>
                          <li>·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·Éò·Éú·Éí·Éö·Éò·É°·É£·É† ·Éê·É°·Éù·Éî·Éë·É°, ·É™·Éò·É§·É†·Éî·Éë·É° ·Éì·Éê ·É°·Éû·Éî·É™·Éò·Éê·Éö·É£·É† ·É°·Éò·Éõ·Éë·Éù·Éö·Éù·Éî·Éë·É° (!@#$%^&*()_+=-)</li>
                        </ul>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            ) : (
              /* ·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éî·Éë·É£·Éö·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éò·É°·Éó·Éï·Éò·É° ·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éê */
              <div className="bg-green-50 border border-green-200 rounded-lg p-6">
                <div className="flex items-center mb-2">
                  <User className="w-5 h-5 text-green-600 mr-2" />
                  <h3 className="text-lg font-semibold text-green-800">
                    ‚úÖ ·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éî·Éë·É£·Éö·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò
                  </h3>
                </div>
                <p className="text-green-800 font-medium">
                  {authenticatedUser.firstName} {authenticatedUser.lastName}
                </p>
                <p className="text-green-600 text-sm mt-1">
                  ·Éó·É•·Éï·Éî·Éú·Éò ·Éû·Éò·É†·Éê·Éì·Éò ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éê·Éï·É¢·Éù·Éõ·Éê·É¢·É£·É†·Éê·Éì ·Éí·Éê·Éõ·Éù·Éò·Éß·Éî·Éú·Éî·Éë·Éê ·ÉØ·Éê·Éï·É®·Éú·Éò·É°·Éó·Éï·Éò·É°
                </p>
              </div>
            )}

            {/* ·É°·É¢·É£·Éõ·É†·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê */}
            <div className="bg-gray-50 p-6 rounded-xl">
              <h3 className="text-lg font-semibold mb-4 flex items-center">
                <Users className="w-5 h-5 mr-2" />
                ·É°·É¢·É£·Éõ·É†·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê
              </h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label htmlFor="adults" className="block text-sm font-medium text-gray-700 mb-2">·Éñ·É†·Éì·Éê·É°·É†·É£·Éö·Éî·Éë·Éò</label>
                  <input
                    id="adults"
                    type="number"
                    name="adults"
                    value={form.adults}
                    min={1}
                    max={10}
                    onChange={handleChange}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    required
                    readOnly={mode === 'view'}
                  />
                </div>
                <div>
                  <label htmlFor="children" className="block text-sm font-medium text-gray-700 mb-2">·Éë·Éê·Éï·É®·Éï·Éî·Éë·Éò</label>
                  <input
                    id="children"
                    type="number"
                    name="children"
                    value={form.children}
                    min={0}
                    max={10}
                    onChange={handleChange}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    readOnly={mode === 'view'}
                  />
                </div>
              </div>
            </div>

            {/* ·Éó·Éê·É†·Éò·É¶·Éî·Éë·Éò */}
            <div className="bg-gray-50 p-6 rounded-xl">
              <h3 className="text-lg font-semibold mb-4 flex items-center">
                <Calendar className="w-5 h-5 mr-2" />
                ·Éó·Éê·É†·Éò·É¶·Éî·Éë·Éò
              </h3>
              <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <CustomCalendar 
                  bookedDates={bookedDates}
                  onDateSelect={(date) => {
                    if (!isDateAvailable(date)) return;

                    setForm(prev => {
                      const currentStartDate = prev.startDate;
                      const currentEndDate = prev.endDate;

                      if (!currentStartDate || (currentStartDate && currentEndDate)) {
                          return { ...prev, startDate: date, endDate: null };
                      } else if (currentStartDate && !currentEndDate) {
                          if (date > currentStartDate) {
                              const rangeStart = new Date(currentStartDate);
                              const rangeEnd = new Date(date);

                              if (isRangeOverlappingWithBookedDates(rangeStart, rangeEnd)) {
                                  alert('·Éê·É†·É©·Éî·É£·Éö·Éò ·Éó·Éê·É†·Éò·É¶·Éî·Éë·Éò·É° ·Éì·Éò·Éê·Éû·Éê·Éñ·Éù·Éú·Éò ·É®·Éî·Éò·É™·Éê·Éï·É° ·É£·Éô·Éï·Éî ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éò·Éö ·Éó·Éê·É†·Éò·É¶·Éî·Éë·É°. ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éê·Éò·É†·É©·Éò·Éù·Éó ·É°·ÉÆ·Éï·Éê ·Éì·Éò·Éê·Éû·Éê·Éñ·Éù·Éú·Éò.');
                                  return prev;
                              }

                              return { ...prev, endDate: date };
                          } else {
                              return { ...prev, startDate: date, endDate: null };
                          }
                      }
                      return prev;
                    });
                  }}
                  selectedDate={form.startDate}
                  endDate={form.endDate}
                  minDate={new Date()}
                  className="mx-auto"
                />

                <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                  <div className="text-sm space-y-2">
                    <div className="flex items-center justify-between">
                      <span className="font-medium text-blue-800">·Éõ·Éù·É°·Éï·Éö·Éò·É° ·Éó·Éê·É†·Éò·É¶·Éò:</span>
                      <span className="text-blue-700">
                        {form.startDate ? form.startDate.toLocaleDateString('ka-GE') : '·Éê·É† ·Éê·É†·Éò·É° ·Éê·É†·É©·Éî·É£·Éö·Éò'}
                      </span>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="font-medium text-blue-800">·É¨·Éê·É°·Éï·Éö·Éò·É° ·Éó·Éê·É†·Éò·É¶·Éò:</span>
                      <span className="text-blue-700">
                        {form.endDate ? form.endDate.toLocaleDateString('ka-GE') : 
                         form.startDate ? '·Éê·Éò·É†·É©·Éò·Éî·Éó ·É¨·Éê·É°·Éï·Éö·Éò·É° ·Éó·Éê·É†·Éò·É¶·Éò' : '·Éû·Éò·É†·Éï·Éî·Éö ·É†·Éò·Éí·É®·Éò ·Éê·Éò·É†·É©·Éò·Éî·Éó ·Éõ·Éù·É°·Éï·Éö·Éò·É° ·Éó·Éê·É†·Éò·É¶·Éò'}
                      </span>
                    </div>
                  </div>
                </div>

{pricing && (
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <h4 className="font-semibold text-blue-800 mb-2">·É§·Éê·É°·Éò·É° ·Éì·Éî·É¢·Éê·Éö·Éî·Éë·Éò</h4>
                <div className="space-y-1 text-sm text-blue-700">
                  <div className="flex justify-between">
                    <span>
                      {form.useCustomPrice && form.customTotalPrice ? '·Éë·Éê·Éñ·Éò·É°·É£·É†·Éò ·É¢·Éê·É†·Éò·É§·Éò (·Éò·Éï·Éö·Éò·É°·Éò)' : `·É°·Éî·Éñ·Éù·Éú·É£·É†·Éò ·É§·Éê·É°·Éò (${form.startDate ? form.startDate.toLocaleDateString('ka-GE', { month: 'long', day: 'numeric' }) : pricing.season})`}:
                    </span>
                    <span>{Math.round(pricing.baseRate)}‚Çæ</span>
                  </div>
                  {pricing.adults > 4 && (
                    <div className="flex justify-between">
                      <span>·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éò·Éó·Éò ·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éê·Éì·Éò ·Éñ·É†·Éì·Éê·É°·É†·É£·Éö·Éî·Éë·Éñ·Éî:</span>
                      <span>+20‚Çæ</span>
                    </div>
                  )}
                  {pricing.additionalGuestFee > 0 && (
                    <div className="flex justify-between">
                      <span>·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éò·Éó·Éò ·Éñ·É†·Éì·Éê·É°·É†·É£·Éö·Éò ({Math.round(pricing.additionalGuestFee / 20)}):</span>
                      <span>+{pricing.additionalGuestFee}‚Çæ</span>
                    </div>
                  )}
                  <div className="flex justify-between">
                    <span>·Éô·Éù·Éõ·É£·Éú·Éê·Éö·É£·É†·Éò ·Éõ·Éù·Éõ·É°·Éê·ÉÆ·É£·É†·Éî·Éë·Éê:</span>
                    <span>+{pricing.utilityCost}‚Çæ</span>
                  </div>
                  <div className="flex justify-between">
                    <span>·É¶·Éê·Éõ·Éî·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê:</span>
                    <span>{pricing.nights}</span>
                  </div>
                  {pricing.isLongStay && (
                    <div className="text-green-600 text-xs">
                      ‚úì ·Éí·É†·É´·Éî·Éö·Éï·Éê·Éì·Éò·Éê·Éú·Éò ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·Éê (21+ ·É¶·Éê·Éõ·Éî)
                    </div>
                  )}
                  <hr className="border-blue-200" />
                  <div className="flex justify-between font-semibold">
                    <span>·É¶·Éê·Éõ·Éî·É®·Éò:</span>
                    <span>{pricing.pricePerNight}‚Çæ</span>
                  </div>
                  <div className="flex justify-between font-semibold text-lg">
                    <span>·ÉØ·Éê·Éõ·É£·É†·Éò ·É§·Éê·É°·Éò:</span>
                    <span>{pricing.totalPrice + (pricing.adults > 4 ? 20 : 0)}‚Çæ</span>
                  </div>
                  <hr className="border-blue-200" />
                  <div className="flex justify-between text-green-600 font-semibold">
                    <span>·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·Éí·Éê·É°·Éê·Éê·É•·É¢·Éò·É£·É†·Éî·Éë·Éî·Éö·Éò ·Éó·Éê·Éú·ÉÆ·Éê:</span>
                    <span>{pricing.depositAmount}‚Çæ</span>
                  </div>
                  <div className="flex justify-between text-orange-600 font-semibold">
                    <span>·É©·Éî·É•·Éò·Éú·Éò·É° ·Éì·É¶·Éî·É° ·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éî·Éö·Éò:</span>
                    <span>{pricing.remainingAmount}‚Çæ</span>
                  </div>
                  <div className="flex justify-between text-purple-600">
                    <span>·Éî·É†·Éó ·Éû·Éò·É†·Éñ·Éî ·É°·Éê·É®·É£·Éê·Éö·Éù ·É¶·Éò·É†·Éî·Éë·É£·Éö·Éî·Éë·Éê:</span>
                    <span>{Math.round(pricing.totalPrice / form.adults)}‚Çæ</span>
                  </div>
                  {form.children > 0 && (
                    <div className="flex justify-between text-green-600">
                      <span>·Éë·Éê·Éï·É®·Éï·Éî·Éë·Éò ({form.children}):</span>
                      <span>·É£·É§·Éê·É°·Éù·Éê</span>
                    </div>
                  )}
                </div>
              </div>
            )}
              </div>
            </div>

            {/* ·Éì·É†·Éù */}
            <div className="bg-gray-50 p-6 rounded-xl">
              <h3 className="text-lg font-semibold mb-4 flex items-center">
                <Clock className="w-5 h-5 mr-2" />
                ·Éì·É†·Éù
              </h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label htmlFor="arrivalTime" className="block text-sm font-medium text-gray-700 mb-2">·Éõ·Éù·É°·Éï·Éö·Éò·É° ·Éì·É†·Éù</label>
                  <input
                    id="arrivalTime"
                    type="time"
                    name="arrivalTime"
                    value={form.arrivalTime}
                    onChange={handleChange}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    readOnly={mode === 'view'}
                  />
                </div>
                <div>
                  <label htmlFor="departureTime" className="block text-sm font-medium text-gray-700 mb-2">·Éí·Éê·É°·Éï·Éö·Éò·É° ·Éì·É†·Éù</label>
                  <input
                    id="departureTime"
                    type="time"
                    name="departureTime"
                    value={form.departureTime}
                    onChange={handleChange}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    readOnly={mode === 'view'}
                  />
                </div>
              </div>
            </div>

            {/* ·Éò·Éú·Éì·Éò·Éï·Éò·Éì·É£·Éê·Éö·É£·É†·Éò ·É§·Éê·É°·Éò·É° ·Éô·Éù·Éì·Éò */}
            <div className="bg-orange-50 p-6 rounded-xl">
              <h3 className="text-lg font-semibold mb-4 flex items-center">
                <CreditCard className="w-5 h-5 mr-2" />
                ·Éò·Éú·Éì·Éò·Éï·Éò·Éì·É£·Éê·Éö·É£·É†·Éò ·É§·Éê·É°·Éò
              </h3>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ·É§·Éê·É°·Éò·É° ·Éô·Éù·Éì·Éò
                  </label>
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={priceCode}
                      onChange={(e) => setPriceCode(e.target.value)}
                      placeholder="·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éî·Éó 6-·É™·Éò·É§·É†·Éò·Éê·Éú·Éò ·Éô·Éù·Éì·Éò"
                      className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      maxLength={6}
                      readOnly={mode === 'view'}
                    />
                    <button
                      type="button"
                      onClick={validateCode}
                      disabled={isValidatingCode || !priceCode.trim() || mode === 'view'}
                      className="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                    >
                      {isValidatingCode ? 'üîç' : '·É®·Éî·Éõ·Éù·É¨·Éõ·Éî·Éë·Éê'}
                    </button>
                  </div>

                  {codeValidationError && (
                    <p className="mt-2 text-sm text-red-600">‚ùå {codeValidationError}</p>
                  )}

                  {isCodeValid && (
                    <div className="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                      <p className="text-sm text-green-800">
                        ‚úÖ ·Éô·Éù·Éì·Éò ·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·É£·Éö·Éò·Éê! ·Éê·ÉÆ·Éö·Éê ·É®·Éî·Éí·Éò·É´·Éö·Éò·Éê·Éó ·Éò·Éú·Éì·Éò·Éï·Éò·Éì·É£·Éê·Éö·É£·É†·Éò ·É§·Éê·É°·Éò·É° ·Éõ·Éò·Éó·Éò·Éó·Éî·Éë·Éê.
                      </p>
                    </div>
                  )}
                </div>

                {isCodeValid && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      ·ÉØ·Éê·Éõ·É£·É†·Éò ·É§·Éê·É°·Éò (‚Çæ)
                    </label>
                    <input
                      type="number"
                      name="customTotalPrice"
                      value={form.customTotalPrice || ''}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éî·Éó ·ÉØ·Éê·Éõ·É£·É†·Éò ·É§·Éê·É°·Éò"
                      min="1"
                      readOnly={mode === 'view'}
                    />
                  </div>
                )}
              </div>
            </div>

            {/* ·É®·Éî·Éú·Éò·É®·Éï·Éú·Éî·Éë·Éò */}
            <div>
              <label htmlFor="notes" className="block text-sm font-medium text-gray-700 mb-2">·É®·Éî·Éú·Éò·É®·Éï·Éú·Éî·Éë·Éò</label>
              <textarea
                id="notes"
                name="notes"
                value={form.notes}
                onChange={handleChange}
                rows={3}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éò·Éó·Éò ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éê..."
                readOnly={mode === 'view'}
              />
            </div>

            {/* ·É¶·Éò·Éö·Éê·Éô·Éî·Éë·Éò */}
            <div className="flex gap-4 pt-6">
              <button
                type="button"
                onClick={onClose}
                className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-lg font-medium transition-colors"
              >
                 {mode === 'view' ? '·Éì·Éê·ÉÆ·É£·É†·Éï·Éê' : '·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê'}
              </button>
              {mode !== 'view' && (
              <button
                type="submit"
                disabled={loading || !form.startDate || !form.endDate || form.endDate <= form.startDate || !form.firstName || !form.lastName || !form.personalId || !form.phone}
                className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center"
              >
                {loading ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                    ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê...
                  </>
                ) : (
                  '·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê'
                )}
              </button>
              )}
            </div>
          </form>
        </div>

        {/* Authentication Modal */}
        {showAuthModal && (
          <BookingAuth
            onAuthSuccess={handleAuthSuccess}
            onBack={() => {
              setShowAuthModal(false);
              setUserCheckPerformed(false);
              setShowExistingUserBanner(false);
            }}
            preFilledPhone={form.phone}
            preFilledPersonalId={form.personalId}
          />
        )}

        {/* Confirmation Modal */}
        {showConfirmationModal && (
          <ConfirmationModal
            isOpen={showConfirmationModal}
            onClose={() => {
              setShowConfirmationModal(false);
              setBookingSuccess(false);
              onClose(); // ·É´·Éò·É†·Éò·Éó·Éê·Éì·Éò ·Éõ·Éù·Éì·Éê·Éö·Éò·É° ·Éì·Éê·ÉÆ·É£·É†·Éï·Éê
            }}
            bookingData={{
              cottageId: cottageId,
              cottageName: cottageName,
              startDate: form.startDate!,
              endDate: form.endDate!,
              totalPrice: form.useCustomPrice && form.customTotalPrice ? form.customTotalPrice : pricing?.totalPrice || 0,
              depositAmount: pricing?.depositAmount || 0,
              customerName: `${form.firstName} ${form.lastName}`
            }}
          />
        )}
      </div>
      <ValidationModal
        isOpen={isValidationModalOpen}
        onClose={hideValidationErrors}
        errors={validationErrors}
        title="·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·É§·Éù·É†·Éõ·Éò·É° ·É®·Éî·Éï·É°·Éî·Éë·Éê ·Éì·Éê·É£·É°·É†·É£·Éö·Éî·Éë·Éî·Éö·Éò·Éê"
      />
    </div>
  );
}