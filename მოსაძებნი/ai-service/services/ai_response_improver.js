
const responsePatterns = {
  // áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜ áƒ¤áƒáƒ áƒ›áƒ”áƒ‘áƒ˜ -> áƒ¡áƒ¬áƒáƒ áƒ˜ áƒ¤áƒáƒ áƒ›áƒ”áƒ‘áƒ˜ (áƒ’áƒáƒ¤áƒáƒ áƒ—áƒáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ•áƒ”áƒ áƒ¡áƒ˜áƒ)
  artificialFixes: {
    'áƒ¨áƒ”áƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ áƒ›áƒáƒ®áƒ“áƒ': 'áƒ¨áƒ”áƒ¡áƒ áƒ£áƒšáƒ“áƒ',
    'áƒáƒœáƒáƒšáƒ˜áƒ–áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒáƒ áƒ”áƒ‘áƒ': 'áƒáƒœáƒáƒšáƒ˜áƒ–áƒ˜', 
    'áƒ›áƒáƒ¥áƒ›áƒ”áƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒœáƒ®áƒáƒ áƒªáƒ˜áƒ”áƒšáƒ”áƒ‘áƒ': 'áƒ›áƒáƒ¥áƒ›áƒ”áƒ“áƒ”áƒ‘áƒ',
    'áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ': 'áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ',
    'áƒ“áƒáƒ›áƒ£áƒ¨áƒáƒ•áƒ”áƒ‘áƒ˜áƒ¡ áƒžáƒ áƒáƒªáƒ”áƒ¡áƒ˜': 'áƒ“áƒáƒ›áƒ£áƒ¨áƒáƒ•áƒ”áƒ‘áƒ',
    'áƒ¨áƒ”áƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒáƒ áƒ”áƒ‘áƒ': 'áƒ¨áƒ”áƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ',
    'áƒ¤áƒ£áƒœáƒ¥áƒªáƒ˜áƒáƒœáƒ˜áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ£áƒ–áƒ áƒ£áƒœáƒ•áƒ”áƒšáƒ§áƒáƒ¤áƒ': 'áƒ¤áƒ£áƒœáƒ¥áƒªáƒ˜áƒáƒœáƒ˜áƒ áƒ”áƒ‘áƒ',
    'áƒ›áƒáƒ›áƒ¡áƒáƒ®áƒ£áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒ¬áƒ”áƒ•áƒ': 'áƒ›áƒáƒ›áƒ¡áƒáƒ®áƒ£áƒ áƒ”áƒ‘áƒ',
    'áƒ™áƒáƒœáƒ¢áƒ áƒáƒšáƒ˜áƒ¡ áƒ’áƒáƒœáƒ®áƒáƒ áƒªáƒ˜áƒ”áƒšáƒ”áƒ‘áƒ': 'áƒ™áƒáƒœáƒ¢áƒ áƒáƒšáƒ˜',
    'áƒáƒ¦áƒ áƒ˜áƒªáƒ®áƒ•áƒ˜áƒ¡ áƒ¬áƒáƒ áƒ›áƒáƒ”áƒ‘áƒ': 'áƒáƒ¦áƒ áƒ˜áƒªáƒ®áƒ•áƒ',
    'áƒ›áƒáƒœáƒ˜áƒ¢áƒáƒ áƒ˜áƒœáƒ’áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒáƒ áƒ”áƒ‘áƒ': 'áƒ›áƒáƒœáƒ˜áƒ¢áƒáƒ áƒ˜áƒœáƒ’áƒ˜',
    'áƒ•áƒáƒšáƒ˜áƒ“áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ¨áƒ”áƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ': 'áƒ•áƒáƒšáƒ˜áƒ“áƒáƒªáƒ˜áƒ',
    'áƒ¡áƒ˜áƒœáƒ¥áƒ áƒáƒœáƒ˜áƒ–áƒáƒªáƒ˜áƒ˜áƒ¡ áƒžáƒ áƒáƒªáƒ”áƒ¡áƒ˜': 'áƒ¡áƒ˜áƒœáƒ¥áƒ áƒáƒœáƒ˜áƒ–áƒáƒªáƒ˜áƒ',
    'áƒ’áƒáƒ“áƒáƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒáƒ áƒ”áƒ‘áƒ': 'áƒ’áƒáƒ“áƒáƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ',
    'áƒ¨áƒ”áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒ˜áƒ›áƒ“áƒ˜áƒœáƒáƒ áƒ”áƒáƒ‘áƒ': 'áƒ¨áƒ”áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ'
  },

  // áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ£áƒ áƒ˜ áƒ—áƒ•áƒ˜áƒ—áƒáƒ¦áƒ áƒ˜áƒªáƒ®áƒ•áƒ˜áƒ¡ áƒáƒªáƒ˜áƒšáƒ”áƒ‘áƒ (áƒ’áƒáƒ¤áƒáƒ áƒ—áƒáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ•áƒ”áƒ áƒ¡áƒ˜áƒ)
  selfIdentificationBlocks: {
    'áƒ›áƒ” áƒ•áƒáƒ  AI áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ': '',
    'áƒ›áƒ” áƒ•áƒáƒ  áƒ®áƒ”áƒšáƒáƒ•áƒœáƒ£áƒ áƒ˜ áƒ˜áƒœáƒ¢áƒ”áƒšáƒ”áƒ¥áƒ¢áƒ˜': '',
    'áƒ›áƒ” áƒ•áƒáƒ  áƒáƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒœáƒ¢áƒ˜ áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ': '',
    'áƒ›áƒ” áƒ•áƒáƒ  áƒ‘áƒáƒ®áƒ›áƒáƒ áƒáƒ¡ AI': '',
    'áƒ›áƒ” áƒ•áƒáƒ  áƒ™áƒáƒ›áƒžáƒ˜áƒ£áƒ¢áƒ”áƒ áƒ£áƒšáƒ˜ áƒžáƒ áƒáƒ’áƒ áƒáƒ›áƒ': '',
    'áƒ áƒáƒ’áƒáƒ áƒª AI áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ': '',
    'áƒ áƒáƒ’áƒáƒ áƒª áƒ®áƒ”áƒšáƒáƒ•áƒœáƒ£áƒ áƒ˜ áƒ˜áƒœáƒ¢áƒ”áƒšáƒ”áƒ¥áƒ¢áƒ˜': '',
    'áƒ›áƒ” áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒáƒ“': '',
    'áƒ©áƒ”áƒ›áƒ˜ áƒ áƒáƒšáƒ˜ áƒ áƒáƒ’áƒáƒ áƒª AI': '',
    'áƒ›áƒ” áƒ•áƒ›áƒ£áƒ¨áƒáƒáƒ‘ áƒ áƒáƒ’áƒáƒ áƒª AI': '',
    'áƒ›áƒ” áƒ•áƒáƒ  áƒ›áƒáƒœáƒ¥áƒáƒœáƒ': '',
    'áƒ›áƒ” áƒ•áƒáƒ  áƒáƒ•áƒ¢áƒáƒ›áƒáƒ¢áƒ£áƒ áƒ˜ áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ': ''
  },

  // áƒ™áƒáƒ›áƒžáƒáƒœáƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜áƒ¡áƒ áƒ“áƒ áƒ¡áƒ”áƒ áƒ•áƒ˜áƒ¡áƒ”áƒ‘áƒ˜áƒ¡ áƒáƒ®áƒ¡áƒœáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡
  explanationTemplates: {
    service: 'áƒ”áƒ¡ áƒ¡áƒ”áƒ áƒ•áƒ˜áƒ¡áƒ˜ áƒžáƒáƒ¡áƒ£áƒ®áƒ˜áƒ¡áƒ›áƒ’áƒ”áƒ‘áƒ”áƒšáƒ˜áƒ {functionality}-áƒ–áƒ” áƒ“áƒ áƒ¨áƒ”áƒ˜áƒªáƒáƒ•áƒ¡ {functions} áƒ¤áƒ£áƒœáƒ¥áƒªáƒ˜áƒ”áƒ‘áƒ¡',
    component: 'áƒ”áƒ¡ áƒ™áƒáƒ›áƒžáƒáƒœáƒ”áƒœáƒ¢áƒ˜ {purpose} áƒ“áƒ áƒ›áƒ£áƒ¨áƒáƒáƒ‘áƒ¡ {workflow} áƒžáƒ áƒ˜áƒœáƒªáƒ˜áƒžáƒ˜áƒ—',
    logic: 'áƒ”áƒ¡ áƒšáƒáƒ’áƒ˜áƒ™áƒ {description} áƒ“áƒ áƒ˜áƒ§áƒ”áƒœáƒ”áƒ‘áƒ¡ {methods} áƒ›áƒ”áƒ—áƒáƒ“áƒ”áƒ‘áƒ¡'
  },

  // áƒ¢áƒ”áƒ¥áƒœáƒ˜áƒ™áƒ£áƒ áƒ˜ áƒ¢áƒ”áƒ áƒ›áƒ˜áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒ•áƒáƒ áƒ˜áƒáƒœáƒ¢áƒ”áƒ‘áƒ˜
  technicalTerms: {
    'booking': 'áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜',
    'service': 'áƒ¡áƒ”áƒ áƒ•áƒ˜áƒ¡áƒ˜', 
    'component': 'áƒ™áƒáƒ›áƒžáƒáƒœáƒ”áƒœáƒ¢áƒ˜',
    'function': 'áƒ¤áƒ£áƒœáƒ¥áƒªáƒ˜áƒ',
    'method': 'áƒ›áƒ”áƒ—áƒáƒ“áƒ˜',
    'validation': 'áƒ•áƒáƒšáƒ˜áƒ“áƒáƒªáƒ˜áƒ',
    'authentication': 'áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ',
    'database': 'áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ—áƒ áƒ‘áƒáƒ–áƒ',
    'API': 'API',
    'endpoint': 'áƒ”áƒœáƒ“áƒ¤áƒáƒ˜áƒœáƒ¢áƒ˜'
  },
  
  // áƒ‘áƒ£áƒœáƒ”áƒ‘áƒ áƒ˜áƒ•áƒ˜ áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒ¡áƒ˜áƒœáƒáƒœáƒ˜áƒ›áƒ”áƒ‘áƒ˜
  naturalSynonyms: {
    'áƒ¨áƒ”áƒáƒ¡áƒ áƒ£áƒšáƒ': 'áƒ’áƒáƒáƒ™áƒ”áƒ—áƒ',
    'áƒ’áƒáƒœáƒáƒ®áƒáƒ áƒªáƒ˜áƒ”áƒšáƒ': 'áƒ¨áƒ”áƒáƒ¡áƒ áƒ£áƒšáƒ', 
    'áƒ’áƒáƒ›áƒáƒ›áƒ˜áƒ¢áƒáƒœáƒ”': 'áƒ’áƒáƒ›áƒáƒ˜áƒ¢áƒáƒœáƒ”',
    'áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ': 'áƒ›áƒ£áƒ¨áƒáƒáƒ‘áƒ¡',
    'áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ—': 'áƒ™áƒáƒ áƒ’áƒáƒ“',
    'áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ áƒ›áƒáƒ®áƒ“áƒ': 'áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒáƒ',
    'áƒ©áƒáƒ›áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ': 'áƒ’áƒáƒ“áƒ›áƒáƒ¬áƒ”áƒ áƒ',
    'áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ': 'áƒáƒ›áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ',
    'áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ': 'áƒ“áƒáƒ–áƒáƒ’áƒ•áƒ',
    'áƒ’áƒáƒœáƒáƒ®áƒšáƒ”áƒ‘áƒ': 'áƒáƒžáƒ“áƒ”áƒ˜áƒ¢áƒ˜',
    'áƒ’áƒáƒ›áƒáƒ«áƒáƒ®áƒ”áƒ‘áƒ': 'áƒ’áƒáƒ›áƒáƒ«áƒáƒ®áƒ”áƒ‘áƒ',
    'áƒ’áƒáƒ›áƒáƒ§áƒ”áƒœáƒ”áƒ‘áƒ': 'áƒ˜áƒ§áƒ”áƒœáƒ”áƒ‘áƒ',
    'áƒ“áƒáƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ”áƒ‘áƒ': 'áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜',
    'áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ': 'áƒ¨áƒ”áƒªáƒ•áƒšáƒ',
    'áƒ•áƒáƒšáƒ˜áƒ“áƒáƒªáƒ˜áƒ': 'áƒ¨áƒ”áƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ',
    'áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ': 'áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ',
    'áƒ™áƒáƒœáƒ¤áƒ˜áƒ’áƒ£áƒ áƒáƒªáƒ˜áƒ': 'áƒ™áƒáƒœáƒ¤áƒ˜áƒ’áƒ˜',
    'áƒ“áƒ”áƒžáƒšáƒáƒ˜áƒ›áƒ”áƒœáƒ¢áƒ˜': 'áƒ’áƒáƒœáƒ—áƒáƒ•áƒ¡áƒ”áƒ‘áƒ'
  },

  // áƒ›áƒ”áƒ’áƒáƒ‘áƒ áƒ£áƒšáƒ˜ áƒ“áƒ áƒ‘áƒ£áƒœáƒ”áƒ‘áƒ áƒ˜áƒ•áƒ˜ áƒžáƒáƒ¡áƒ£áƒ®áƒ”áƒ‘áƒ˜
  friendlyResponses: {
    'search_help': 'áƒ áƒ áƒ¤áƒáƒ˜áƒšáƒ¡ áƒ”áƒ«áƒ”áƒ‘? áƒ›áƒ˜áƒ—áƒ®áƒáƒ áƒ˜ áƒ“áƒ áƒ•áƒ˜áƒžáƒáƒ•áƒ˜áƒ— áƒ”áƒ áƒ—áƒáƒ“! ðŸ˜Š',
    'general_confusion': 'áƒ°áƒ›... áƒ¯áƒ”áƒ  áƒ•áƒ”áƒ  áƒ›áƒ˜áƒ•áƒ®áƒ•áƒ“áƒ˜ áƒ áƒáƒ¡ áƒ’áƒ£áƒšáƒ˜áƒ¡áƒ®áƒ›áƒáƒ‘. áƒ¨áƒ”áƒ˜áƒ«áƒšáƒ”áƒ‘áƒ áƒ£áƒ¤áƒ áƒ áƒ“áƒ”áƒ¢áƒáƒšáƒ£áƒ áƒáƒ“ áƒáƒ¦áƒ¬áƒ”áƒ áƒ?',
    'file_search': 'áƒ™áƒáƒ áƒ’áƒ˜, áƒ¤áƒáƒ˜áƒšáƒ˜áƒ¡ áƒ«áƒ”áƒ‘áƒœáƒáƒ¨áƒ˜ áƒ“áƒáƒ’áƒ”áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ˜! áƒ áƒáƒ›áƒ”áƒšáƒ˜ áƒ¤áƒáƒ˜áƒšáƒ˜ áƒ’áƒ­áƒ˜áƒ áƒ“áƒ”áƒ‘áƒ?',
    'dashboard_help': 'áƒ“áƒ”áƒ¨áƒ‘áƒáƒ áƒ“áƒ˜áƒ¡ áƒ¨áƒ”áƒ¡áƒáƒ®áƒ”áƒ‘ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ áƒ’áƒáƒ¥áƒ•áƒ¡? áƒ áƒ áƒ™áƒáƒœáƒ™áƒ áƒ”áƒ¢áƒ£áƒšáƒáƒ“ áƒ’áƒáƒ˜áƒœáƒ¢áƒ”áƒ áƒ”áƒ¡áƒ”áƒ‘áƒ¡?'
  }
};

function improveGeorgianResponse(response) {
  let improved = response;

  // áƒ’áƒáƒ›áƒáƒ•áƒáƒªáƒáƒšáƒáƒ— áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ£áƒ áƒ˜ áƒ—áƒ•áƒ˜áƒ—áƒáƒ¦áƒ áƒ˜áƒªáƒ®áƒ•áƒ”áƒ‘áƒ˜
  Object.entries(responsePatterns.selfIdentificationBlocks).forEach(([pattern, replacement]) => {
    const regex = new RegExp(pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    improved = improved.replace(regex, replacement);
  });

  // Fix artificial patterns
  Object.entries(responsePatterns.artificialFixes).forEach(([bad, good]) => {
    const regex = new RegExp(bad.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    improved = improved.replace(regex, good);
  });

  // áƒ’áƒáƒ¤áƒáƒ áƒ—áƒáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ‘áƒ£áƒœáƒ”áƒ‘áƒ áƒ˜áƒ•áƒ˜ áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒœáƒáƒ™áƒáƒ“áƒ˜
  improved = improved
    .replace(/(\w+)áƒ¡ áƒáƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ¡/g, '$1áƒ¡')
    .replace(/(\w+)áƒ˜áƒ¡ áƒ›áƒáƒžáƒáƒ•áƒ”áƒ‘áƒ/g, '$1áƒ˜áƒ¡ áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ')
    .replace(/áƒ’áƒáƒœáƒ®áƒáƒ áƒªáƒ˜áƒ”áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒ˜áƒ–áƒœáƒ˜áƒ—/g, 'áƒ áƒáƒ› áƒ’áƒáƒœáƒ®áƒáƒ áƒªáƒ˜áƒ”áƒšáƒ“áƒ”áƒ¡')
    .replace(/áƒ¨áƒ”áƒ«áƒšáƒ”áƒ‘áƒáƒ¡ áƒ˜áƒ«áƒšáƒ”áƒ•áƒ/g, 'áƒ¡áƒáƒ¨áƒ£áƒáƒšáƒ”áƒ‘áƒáƒ¡ áƒáƒ«áƒšáƒ”áƒ•áƒ¡')
    .replace(/áƒ£áƒ–áƒ áƒ£áƒœáƒ•áƒ”áƒšáƒ§áƒáƒ¤áƒ¡ áƒ¨áƒ”áƒ¡áƒáƒ«áƒšáƒ”áƒ‘áƒšáƒáƒ‘áƒáƒ¡/g, 'áƒ¡áƒáƒ¨áƒ£áƒáƒšáƒ”áƒ‘áƒáƒ¡ áƒáƒ«áƒšáƒ”áƒ•áƒ¡')
    .replace(/áƒ®áƒáƒ áƒªáƒ˜áƒ”áƒšáƒ“áƒ”áƒ‘áƒ áƒžáƒ áƒáƒªáƒ”áƒ¡áƒ˜/g, 'áƒ›áƒ˜áƒ›áƒ“áƒ˜áƒœáƒáƒ áƒ”áƒáƒ‘áƒ¡')
    .replace(/áƒ›áƒáƒ®áƒ“áƒ”áƒ‘áƒ áƒ’áƒáƒœáƒ®áƒáƒ áƒªáƒ˜áƒ”áƒšáƒ”áƒ‘áƒ/g, 'áƒ’áƒáƒœáƒ®áƒáƒ áƒªáƒ˜áƒ”áƒšáƒ“áƒ”áƒ‘áƒ')
    .replace(/áƒ®áƒ“áƒ”áƒ‘áƒ áƒ¨áƒ”áƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ/g, 'áƒ¨áƒ”áƒ¡áƒ áƒ£áƒšáƒ“áƒ”áƒ‘áƒ')
    .replace(/áƒ•áƒáƒ  áƒáƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒœáƒ¢áƒ˜ áƒ áƒáƒ›áƒ”áƒšáƒ˜áƒª/g, 'áƒáƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒœáƒ¢áƒ˜ áƒ•áƒáƒ , áƒ áƒáƒ›áƒ”áƒšáƒ˜áƒª')
    .replace(/áƒ¨áƒ”áƒ›áƒ˜áƒ«áƒšáƒ˜áƒ áƒ“áƒáƒ’áƒ”áƒ®áƒ›áƒáƒ áƒ/g, 'áƒ¨áƒ”áƒ›áƒ˜áƒ«áƒšáƒ˜áƒ áƒ“áƒáƒ’áƒ”áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ');

  // áƒ—áƒáƒ•áƒ˜áƒ¡áƒ£áƒ¤áƒáƒšáƒ˜ áƒªáƒáƒ áƒ˜áƒ”áƒšáƒ˜ áƒ¡áƒ˜áƒ•áƒ áƒªáƒ”áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒªáƒ˜áƒšáƒ”áƒ‘áƒ
  improved = improved.replace(/\s+/g, ' ').trim();

  return improved;
}

// áƒáƒ®áƒáƒšáƒ˜ áƒ¤áƒ£áƒœáƒ¥áƒªáƒ˜áƒ - fallback-áƒ˜áƒ¡ áƒšáƒáƒ’áƒ˜áƒ™áƒ Groq-áƒ˜áƒ¡ áƒ•áƒ”áƒ  áƒ›áƒ£áƒ¨áƒáƒáƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ—áƒ®áƒ•áƒ”áƒ•áƒáƒ¨áƒ˜
async function improveGeorgianWithFallback(response) {
  try {
    // áƒžáƒ˜áƒ áƒ•áƒ”áƒš áƒ áƒ˜áƒ’áƒ¨áƒ˜ áƒ•áƒªáƒ“áƒ˜áƒšáƒáƒ‘áƒ— Groq-áƒ˜áƒ— áƒ’áƒáƒ£áƒ›áƒ¯áƒáƒ‘áƒ”áƒ¡áƒ”áƒ‘áƒáƒ¡
    if (process.env.GROQ_API_KEY) {
      console.log('ðŸ”§ Trying Groq-based Georgian improvement...');
      
      const { askGroq } = require('./groq_service');
      
      const groqResponse = await askGroq([
        { 
          role: 'system', 
          content: 'áƒ’áƒáƒ¡áƒ¬áƒáƒ áƒ” áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒ’áƒ áƒáƒ›áƒáƒ¢áƒ˜áƒ™áƒ áƒ“áƒ áƒ’áƒáƒ®áƒáƒ“áƒ” áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜ áƒ‘áƒ£áƒœáƒ”áƒ‘áƒ áƒ˜áƒ•áƒ˜. áƒ“áƒáƒáƒ‘áƒ áƒ£áƒœáƒ” áƒ›áƒ®áƒáƒšáƒáƒ“ áƒ’áƒáƒ¡áƒ¬áƒáƒ áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜.' 
        },
        { role: 'user', content: response }
      ]);

      // Enhanced validation of Groq response
      if (groqResponse && 
          groqResponse.choices && 
          Array.isArray(groqResponse.choices) && 
          groqResponse.choices.length > 0 &&
          groqResponse.choices[0].message &&
          groqResponse.choices[0].message.content) {
        
        const groqImproved = groqResponse.choices[0].message.content;

        // áƒ—áƒ£ Groq áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ— áƒ›áƒ£áƒ¨áƒáƒáƒ‘áƒ¡
        if (groqImproved && groqImproved !== response && groqImproved.length > response.length * 0.7) {
          console.log('âœ… Groq Georgian improvement successful');
          return groqImproved;
        }
      } else {
        console.log('âš ï¸ Groq response structure invalid, using fallback');
      }
    }

    // Fallback: áƒšáƒáƒ™áƒáƒšáƒ£áƒ áƒ˜ áƒ’áƒáƒ£áƒ›áƒ¯áƒáƒ‘áƒ”áƒ¡áƒ”áƒ‘áƒ
    console.log('âš¡ Using fallback local Georgian improvement');
    return improveGeorgianResponse(response);

  } catch (error) {
    console.warn('âš ï¸ Georgian improvement error, using local fallback:', error.message);
    return improveGeorgianResponse(response);
  }
}

function analyzeResponseQuality(response) {
  const analysis = {
    georgianPercentage: 0,
    hasArtificialPatterns: false,
    technicalTermsUsed: [],
    readabilityScore: 0,
    suggestions: []
  };

  // Calculate Georgian content percentage
  const georgianChars = (response.match(/[áƒ-áƒ°]/g) || []).length;
  analysis.georgianPercentage = (georgianChars / response.length) * 100;

  // Check for artificial patterns
  const artificialKeys = Object.keys(responsePatterns.artificialFixes);
  analysis.hasArtificialPatterns = artificialKeys.some(pattern => 
    response.includes(pattern)
  );

  // Identify technical terms used
  Object.entries(responsePatterns.technicalTerms).forEach(([eng, geo]) => {
    if (response.includes(geo)) {
      analysis.technicalTermsUsed.push(geo);
    }
  });

  // Simple readability score (sentence length, complexity)
  const sentences = response.split(/[.!?]/).filter(s => s.trim().length > 0);
  const avgSentenceLength = sentences.reduce((sum, s) => sum + s.trim().split(' ').length, 0) / sentences.length;
  analysis.readabilityScore = Math.max(0, 100 - (avgSentenceLength - 15) * 2);

  // Generate suggestions
  if (analysis.georgianPercentage < 80) {
    analysis.suggestions.push('áƒ’áƒáƒ–áƒáƒ áƒ“áƒ”áƒ— áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒ™áƒáƒœáƒ¢áƒ”áƒœáƒ¢áƒ˜áƒ¡ áƒžáƒ áƒáƒªáƒ”áƒœáƒ¢áƒ˜');
  }
  if (analysis.hasArtificialPatterns) {
    analysis.suggestions.push('áƒ’áƒáƒ›áƒáƒ˜áƒ§áƒ”áƒœáƒ”áƒ— áƒ£áƒ¤áƒ áƒ áƒ‘áƒ£áƒœáƒ”áƒ‘áƒ áƒ˜áƒ•áƒ˜ áƒ¤áƒ áƒáƒ–áƒ”áƒ‘áƒ˜');
  }
  if (analysis.readabilityScore < 70) {
    analysis.suggestions.push('áƒ’áƒáƒáƒ›áƒáƒ áƒ¢áƒ˜áƒ•áƒ”áƒ— áƒ¬áƒ˜áƒœáƒáƒ“áƒáƒ“áƒ”áƒ‘áƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒ¢áƒ áƒ£áƒ¥áƒ¢áƒ£áƒ áƒ');
  }

  return analysis;
}

// Basic Georgian fixes for fallback scenarios
function applyBasicGeorgianFixes(text) {
  return text
    .replace(/áƒ¨áƒ”áƒ’áƒ˜áƒ áƒ˜áƒ/g, "áƒ¨áƒ”áƒ’áƒ˜áƒ«áƒšáƒ˜áƒ")
    .replace(/\báƒ™áƒáƒ•\b/g, "áƒ™áƒáƒ˜")
    .replace(/áƒ›áƒ” áƒ“áƒáƒ›áƒ”áƒ®áƒ›áƒáƒ áƒáƒ¡/g, "áƒ›áƒ” áƒ“áƒáƒ›áƒ”áƒ®áƒ›áƒáƒ áƒ")
    .replace(/áƒ¨áƒ”áƒáƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ¡/g, "áƒ¨áƒ”áƒáƒ¡áƒ áƒ£áƒšáƒ")
    .replace(/áƒ©áƒ”áƒ›áƒ˜ áƒ¡áƒáƒ˜áƒ¢áƒ˜/g, "áƒ‘áƒáƒ®áƒ›áƒáƒ áƒáƒ¡ áƒžáƒšáƒáƒ¢áƒ¤áƒáƒ áƒ›áƒ")
    .replace(/áƒ›áƒ” áƒ•áƒáƒ  AI/g, "áƒ‘áƒáƒ®áƒ›áƒáƒ áƒáƒ¡ AI áƒáƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒœáƒ¢áƒ˜ áƒ•áƒáƒ ");
}

module.exports = {
  responsePatterns,
  improveGeorgianResponse,
  improveGeorgianWithFallback,
  analyzeResponseQuality,
  applyBasicGeorgianFixes
};
